var assert = require('assert');
var Big = require('big.js');
var hre = require('hardhat');

const Fuse = require("../dist/fuse.node.commonjs2.js");

assert(process.env.TESTING_WEB3_PROVIDER_URL, "Web3 provider URL required");
var fuse = new Fuse(process.env.TESTING_WEB3_PROVIDER_URL, hre);
hre.ethers.provider = new hre.ethers.providers.Web3Provider(fuse.web3.currentProvider);

var erc20Abi = JSON.parse(fuse.compoundContracts["contracts/EIP20Interface.sol:EIP20Interface"].abi);
var cErc20Abi = JSON.parse(fuse.compoundContracts["contracts/CErc20Delegate.sol:CErc20Delegate"].abi);
var cEtherAbi = JSON.parse(fuse.compoundContracts["contracts/CEtherDelegate.sol:CEtherDelegate"].abi);

// Snapshot + revert + dry run wrapper function
var snapshotId = null;

function snapshot() {
  return new Promise(function(resolve, reject) {
    fuse.web3.currentProvider.send({
      jsonrpc: "2.0",
      method: "evm_snapshot",
      id: 1
    }, function(err, result) {
      if (err) return reject(err);
      snapshotId = result.result;
      resolve();
    });
  });
}

function revert() {
  return new Promise(function(resolve, reject) {
    assert(snapshotId !== null);
    fuse.web3.currentProvider.send({
      jsonrpc: "2.0",
      method: "evm_revert",
      params: [snapshotId],
      id: new Date().getTime()
    }, function(err, result) {
      if (err) return reject(err);
      assert(result.result);
      resolve();
    });
  });
}

function dryRun(promise) {
  return async function() {
    await snapshot();
    var error = null;

    try {
      await promise();
    } catch (_error) {
      error = _error;
    }

    await revert();
    if (error !== null) throw error;
  }
}

// hardhat_impersonateAccount
function impersonateAccount(account) {
  return new Promise(function(resolve, reject) {
    fuse.web3.currentProvider.send({
      jsonrpc: "2.0",
      method: "hardhat_impersonateAccount",
      params: [account],
      id: new Date().getTime()
    }, function(err, result) {
      if (err) return reject(err);
      assert(result.result);
      resolve();
    });
  });
}

// Deploy pool + assets
async function deployPool(conf, options) {
  if (conf.closeFactor === undefined) conf.poolName = "Example Fuse Pool " + (new Date()).getTime();
  if (conf.closeFactor === undefined) conf.closeFactor = Fuse.Web3.utils.toBN(0.5e18);
  else conf.closeFactor = Fuse.Web3.utils.toBN((new Big(conf.closeFactor)).mul((new Big(10)).pow(18)).toFixed(0));
  if (conf.maxAssets === undefined) conf.maxAssets = 20;
  if (conf.liquidationIncentive === undefined) conf.liquidationIncentive = Fuse.Web3.utils.toBN(1.08e18);
  else conf.liquidationIncentive = Fuse.Web3.utils.toBN((new Big(conf.liquidationIncentive)).mul((new Big(10)).pow(18)).toFixed(0));

  var [poolAddress, implementationAddress, priceOracleAddress] = await fuse.deployPool(conf.poolName, conf.isPrivate, conf.closeFactor, conf.maxAssets, conf.liquidationIncentive, conf.priceOracle, conf.priceOracleConf, options);
  return [poolAddress, priceOracleAddress];
}

async function deployAsset(conf, collateralFactor, reserveFactor, adminFee, options, bypassPriceFeedCheck) {
  if (conf.interestRateModel === undefined) conf.interestRateModel = "0x6bc8fe27d0c7207733656595e73c0d5cf7afae36";
  if (conf.decimals === undefined) conf.decimals = 8;
  if (conf.admin === undefined) conf.admin = options.from;
  if (collateralFactor === undefined) collateralFactor = Fuse.Web3.utils.toBN(0.75e18);
  if (reserveFactor === undefined) reserveFactor = Fuse.Web3.utils.toBN(0.2e18);
  if (adminFee === undefined) adminFee = Fuse.Web3.utils.toBN(0.05e18);

  var [assetAddress, implementationAddress, interestRateModel] = await fuse.deployAsset(conf, collateralFactor, reserveFactor, adminFee, options, bypassPriceFeedCheck);
  return assetAddress;
}

// Set FSL address and ABI
fuse.contracts.FuseSafeLiquidator = new fuse.web3.eth.Contract([{"stateMutability":"payable","type":"receive"},{"inputs":[{"internalType":"address","name":"borrower","type":"address"},{"internalType":"contract CEther","name":"cEther","type":"address"},{"internalType":"contract CErc20","name":"cErc20Collateral","type":"address"},{"internalType":"uint256","name":"minOutputAmount","type":"uint256"},{"internalType":"address","name":"exchangeSeizedTo","type":"address"},{"internalType":"contract IUniswapV2Router02","name":"uniswapV2Router","type":"address"},{"internalType":"contract IRedemptionStrategy[]","name":"redemptionStrategies","type":"address[]"},{"internalType":"bytes[]","name":"strategyData","type":"bytes[]"}],"name":"safeLiquidate","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"borrower","type":"address"},{"internalType":"uint256","name":"repayAmount","type":"uint256"},{"internalType":"contract CErc20","name":"cErc20","type":"address"},{"internalType":"contract CToken","name":"cTokenCollateral","type":"address"},{"internalType":"uint256","name":"minOutputAmount","type":"uint256"},{"internalType":"address","name":"exchangeSeizedTo","type":"address"},{"internalType":"contract IUniswapV2Router02","name":"uniswapV2Router","type":"address"},{"internalType":"contract IRedemptionStrategy[]","name":"redemptionStrategies","type":"address[]"},{"internalType":"bytes[]","name":"strategyData","type":"bytes[]"}],"name":"safeLiquidate","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"borrower","type":"address"},{"internalType":"uint256","name":"repayAmount","type":"uint256"},{"internalType":"contract CErc20","name":"cErc20","type":"address"},{"internalType":"contract CToken","name":"cTokenCollateral","type":"address"},{"internalType":"uint256","name":"minProfitAmount","type":"uint256"},{"internalType":"address","name":"exchangeProfitTo","type":"address"},{"internalType":"contract IUniswapV2Router02","name":"uniswapV2RouterForBorrow","type":"address"},{"internalType":"contract IUniswapV2Router02","name":"uniswapV2RouterForCollateral","type":"address"},{"internalType":"contract IRedemptionStrategy[]","name":"redemptionStrategies","type":"address[]"},{"internalType":"bytes[]","name":"strategyData","type":"bytes[]"},{"internalType":"uint256","name":"ethToCoinbase","type":"uint256"}],"name":"safeLiquidateToTokensWithFlashLoan","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"borrower","type":"address"},{"internalType":"uint256","name":"repayAmount","type":"uint256"},{"internalType":"contract CEther","name":"cEther","type":"address"},{"internalType":"contract CErc20","name":"cErc20Collateral","type":"address"},{"internalType":"uint256","name":"minProfitAmount","type":"uint256"},{"internalType":"address","name":"exchangeProfitTo","type":"address"},{"internalType":"contract IUniswapV2Router02","name":"uniswapV2RouterForCollateral","type":"address"},{"internalType":"contract IRedemptionStrategy[]","name":"redemptionStrategies","type":"address[]"},{"internalType":"bytes[]","name":"strategyData","type":"bytes[]"},{"internalType":"uint256","name":"ethToCoinbase","type":"uint256"}],"name":"safeLiquidateToEthWithFlashLoan","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"sender","type":"address"},{"internalType":"uint256","name":"amount0","type":"uint256"},{"internalType":"uint256","name":"amount1","type":"uint256"},{"internalType":"bytes","name":"data","type":"bytes"}],"name":"uniswapV2Call","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"contract IERC20Upgradeable","name":"underlyingCollateral","type":"address"},{"internalType":"uint256","name":"underlyingCollateralSeized","type":"uint256"},{"internalType":"contract IRedemptionStrategy","name":"strategy","type":"address"},{"internalType":"bytes","name":"strategyData","type":"bytes"}],"name":"redeemCustomCollateral","outputs":[{"internalType":"contract IERC20Upgradeable","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"nonpayable","type":"function"}], "0x5eb3Bc0a489C5A8288765d2336659EbCA68FCd00");

Fuse.CERC20_DELEGATE_CONTRACT_ADDRESS = undefined;
fuse.compoundContracts["contracts/CErc20Delegate.sol:CErc20Delegate"] = {"abi":"[{\"inputs\":[],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"constructor\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"cashPrior\",\"type\":\"uint256\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"interestAccumulated\",\"type\":\"uint256\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"borrowIndex\",\"type\":\"uint256\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"totalBorrows\",\"type\":\"uint256\"}],\"name\":\"AccrueInterest\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[],\"name\":\"AdminRightsRenounced\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"address\",\"name\":\"owner\",\"type\":\"address\"},{\"indexed\":true,\"internalType\":\"address\",\"name\":\"spender\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"amount\",\"type\":\"uint256\"}],\"name\":\"Approval\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"internalType\":\"address\",\"name\":\"borrower\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"borrowAmount\",\"type\":\"uint256\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"accountBorrows\",\"type\":\"uint256\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"totalBorrows\",\"type\":\"uint256\"}],\"name\":\"Borrow\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"error\",\"type\":\"uint256\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"info\",\"type\":\"uint256\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"detail\",\"type\":\"uint256\"}],\"name\":\"Failure\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[],\"name\":\"FuseAdminRightsRenounced\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"internalType\":\"address\",\"name\":\"liquidator\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"address\",\"name\":\"borrower\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"repayAmount\",\"type\":\"uint256\"},{\"indexed\":false,\"internalType\":\"address\",\"name\":\"cTokenCollateral\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"seizeTokens\",\"type\":\"uint256\"}],\"name\":\"LiquidateBorrow\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"internalType\":\"address\",\"name\":\"minter\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"mintAmount\",\"type\":\"uint256\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"mintTokens\",\"type\":\"uint256\"}],\"name\":\"Mint\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"internalType\":\"address\",\"name\":\"oldAdmin\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"address\",\"name\":\"newAdmin\",\"type\":\"address\"}],\"name\":\"NewAdmin\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"oldAdminFeeMantissa\",\"type\":\"uint256\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"newAdminFeeMantissa\",\"type\":\"uint256\"}],\"name\":\"NewAdminFee\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"internalType\":\"contract ComptrollerInterface\",\"name\":\"oldComptroller\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"contract ComptrollerInterface\",\"name\":\"newComptroller\",\"type\":\"address\"}],\"name\":\"NewComptroller\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"oldFuseFeeMantissa\",\"type\":\"uint256\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"newFuseFeeMantissa\",\"type\":\"uint256\"}],\"name\":\"NewFuseFee\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"internalType\":\"contract InterestRateModel\",\"name\":\"oldInterestRateModel\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"contract InterestRateModel\",\"name\":\"newInterestRateModel\",\"type\":\"address\"}],\"name\":\"NewMarketInterestRateModel\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"internalType\":\"address\",\"name\":\"oldPendingAdmin\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"address\",\"name\":\"newPendingAdmin\",\"type\":\"address\"}],\"name\":\"NewPendingAdmin\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"oldReserveFactorMantissa\",\"type\":\"uint256\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"newReserveFactorMantissa\",\"type\":\"uint256\"}],\"name\":\"NewReserveFactor\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"internalType\":\"address\",\"name\":\"redeemer\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"redeemAmount\",\"type\":\"uint256\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"redeemTokens\",\"type\":\"uint256\"}],\"name\":\"Redeem\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"internalType\":\"address\",\"name\":\"payer\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"address\",\"name\":\"borrower\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"repayAmount\",\"type\":\"uint256\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"accountBorrows\",\"type\":\"uint256\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"totalBorrows\",\"type\":\"uint256\"}],\"name\":\"RepayBorrow\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"internalType\":\"address\",\"name\":\"benefactor\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"addAmount\",\"type\":\"uint256\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"newTotalReserves\",\"type\":\"uint256\"}],\"name\":\"ReservesAdded\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"internalType\":\"address\",\"name\":\"admin\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"reduceAmount\",\"type\":\"uint256\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"newTotalReserves\",\"type\":\"uint256\"}],\"name\":\"ReservesReduced\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"address\",\"name\":\"from\",\"type\":\"address\"},{\"indexed\":true,\"internalType\":\"address\",\"name\":\"to\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"amount\",\"type\":\"uint256\"}],\"name\":\"Transfer\",\"type\":\"event\"},{\"constant\":false,\"inputs\":[],\"name\":\"_acceptAdmin\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"addAmount\",\"type\":\"uint256\"}],\"name\":\"_addReserves\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"internalType\":\"bytes\",\"name\":\"data\",\"type\":\"bytes\"}],\"name\":\"_becomeImplementation\",\"outputs\":[],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"reduceAmount\",\"type\":\"uint256\"}],\"name\":\"_reduceReserves\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[],\"name\":\"_renounceAdminRights\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[],\"name\":\"_renounceFuseAdminRights\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[],\"name\":\"_resignImplementation\",\"outputs\":[],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"newAdminFeeMantissa\",\"type\":\"uint256\"}],\"name\":\"_setAdminFee\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"internalType\":\"contract ComptrollerInterface\",\"name\":\"newComptroller\",\"type\":\"address\"}],\"name\":\"_setComptroller\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[],\"name\":\"_setFuseFee\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"internalType\":\"contract InterestRateModel\",\"name\":\"newInterestRateModel\",\"type\":\"address\"}],\"name\":\"_setInterestRateModel\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"internalType\":\"address payable\",\"name\":\"newPendingAdmin\",\"type\":\"address\"}],\"name\":\"_setPendingAdmin\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"newReserveFactorMantissa\",\"type\":\"uint256\"}],\"name\":\"_setReserveFactor\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"withdrawAmount\",\"type\":\"uint256\"}],\"name\":\"_withdrawAdminFees\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"withdrawAmount\",\"type\":\"uint256\"}],\"name\":\"_withdrawFuseFees\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"accrualBlockNumber\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[],\"name\":\"accrueInterest\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"admin\",\"outputs\":[{\"internalType\":\"address payable\",\"name\":\"\",\"type\":\"address\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"adminFeeMantissa\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"adminHasRights\",\"outputs\":[{\"internalType\":\"bool\",\"name\":\"\",\"type\":\"bool\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[{\"internalType\":\"address\",\"name\":\"owner\",\"type\":\"address\"},{\"internalType\":\"address\",\"name\":\"spender\",\"type\":\"address\"}],\"name\":\"allowance\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"internalType\":\"address\",\"name\":\"spender\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"amount\",\"type\":\"uint256\"}],\"name\":\"approve\",\"outputs\":[{\"internalType\":\"bool\",\"name\":\"\",\"type\":\"bool\"}],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[{\"internalType\":\"address\",\"name\":\"owner\",\"type\":\"address\"}],\"name\":\"balanceOf\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"internalType\":\"address\",\"name\":\"owner\",\"type\":\"address\"}],\"name\":\"balanceOfUnderlying\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"borrowAmount\",\"type\":\"uint256\"}],\"name\":\"borrow\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"internalType\":\"address\",\"name\":\"account\",\"type\":\"address\"}],\"name\":\"borrowBalanceCurrent\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[{\"internalType\":\"address\",\"name\":\"account\",\"type\":\"address\"}],\"name\":\"borrowBalanceStored\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"borrowIndex\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"borrowRatePerBlock\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"comptroller\",\"outputs\":[{\"internalType\":\"contract ComptrollerInterface\",\"name\":\"\",\"type\":\"address\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"decimals\",\"outputs\":[{\"internalType\":\"uint8\",\"name\":\"\",\"type\":\"uint8\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[],\"name\":\"exchangeRateCurrent\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"exchangeRateStored\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"fuseAdminHasRights\",\"outputs\":[{\"internalType\":\"bool\",\"name\":\"\",\"type\":\"bool\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"fuseFeeMantissa\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[{\"internalType\":\"address\",\"name\":\"account\",\"type\":\"address\"}],\"name\":\"getAccountSnapshot\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"getCash\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"implementation\",\"outputs\":[{\"internalType\":\"address\",\"name\":\"\",\"type\":\"address\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"internalType\":\"contract ComptrollerInterface\",\"name\":\"comptroller_\",\"type\":\"address\"},{\"internalType\":\"contract InterestRateModel\",\"name\":\"interestRateModel_\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"initialExchangeRateMantissa_\",\"type\":\"uint256\"},{\"internalType\":\"string\",\"name\":\"name_\",\"type\":\"string\"},{\"internalType\":\"string\",\"name\":\"symbol_\",\"type\":\"string\"},{\"internalType\":\"uint8\",\"name\":\"decimals_\",\"type\":\"uint8\"},{\"internalType\":\"uint256\",\"name\":\"reserveFactorMantissa_\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"adminFeeMantissa_\",\"type\":\"uint256\"}],\"name\":\"initialize\",\"outputs\":[],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"internalType\":\"address\",\"name\":\"underlying_\",\"type\":\"address\"},{\"internalType\":\"contract ComptrollerInterface\",\"name\":\"comptroller_\",\"type\":\"address\"},{\"internalType\":\"contract InterestRateModel\",\"name\":\"interestRateModel_\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"initialExchangeRateMantissa_\",\"type\":\"uint256\"},{\"internalType\":\"string\",\"name\":\"name_\",\"type\":\"string\"},{\"internalType\":\"string\",\"name\":\"symbol_\",\"type\":\"string\"},{\"internalType\":\"uint8\",\"name\":\"decimals_\",\"type\":\"uint8\"},{\"internalType\":\"uint256\",\"name\":\"reserveFactorMantissa_\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"adminFeeMantissa_\",\"type\":\"uint256\"}],\"name\":\"initialize\",\"outputs\":[],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"interestRateModel\",\"outputs\":[{\"internalType\":\"contract InterestRateModel\",\"name\":\"\",\"type\":\"address\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"isCEther\",\"outputs\":[{\"internalType\":\"bool\",\"name\":\"\",\"type\":\"bool\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"isCToken\",\"outputs\":[{\"internalType\":\"bool\",\"name\":\"\",\"type\":\"bool\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"internalType\":\"address\",\"name\":\"borrower\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"repayAmount\",\"type\":\"uint256\"},{\"internalType\":\"contract CTokenInterface\",\"name\":\"cTokenCollateral\",\"type\":\"address\"}],\"name\":\"liquidateBorrow\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"mintAmount\",\"type\":\"uint256\"}],\"name\":\"mint\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"name\",\"outputs\":[{\"internalType\":\"string\",\"name\":\"\",\"type\":\"string\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"pendingAdmin\",\"outputs\":[{\"internalType\":\"address payable\",\"name\":\"\",\"type\":\"address\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"redeemTokens\",\"type\":\"uint256\"}],\"name\":\"redeem\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"redeemAmount\",\"type\":\"uint256\"}],\"name\":\"redeemUnderlying\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"repayAmount\",\"type\":\"uint256\"}],\"name\":\"repayBorrow\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"internalType\":\"address\",\"name\":\"borrower\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"repayAmount\",\"type\":\"uint256\"}],\"name\":\"repayBorrowBehalf\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"reserveFactorMantissa\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"internalType\":\"address\",\"name\":\"liquidator\",\"type\":\"address\"},{\"internalType\":\"address\",\"name\":\"borrower\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"seizeTokens\",\"type\":\"uint256\"}],\"name\":\"seize\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"supplyRatePerBlock\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"symbol\",\"outputs\":[{\"internalType\":\"string\",\"name\":\"\",\"type\":\"string\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"totalAdminFees\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"totalBorrows\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[],\"name\":\"totalBorrowsCurrent\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"totalFuseFees\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"totalReserves\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"totalSupply\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"internalType\":\"address\",\"name\":\"dst\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"amount\",\"type\":\"uint256\"}],\"name\":\"transfer\",\"outputs\":[{\"internalType\":\"bool\",\"name\":\"\",\"type\":\"bool\"}],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"internalType\":\"address\",\"name\":\"src\",\"type\":\"address\"},{\"internalType\":\"address\",\"name\":\"dst\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"amount\",\"type\":\"uint256\"}],\"name\":\"transferFrom\",\"outputs\":[{\"internalType\":\"bool\",\"name\":\"\",\"type\":\"bool\"}],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"underlying\",\"outputs\":[{\"internalType\":\"address\",\"name\":\"\",\"type\":\"address\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"}]","bin":"60806040526001805460ff60a81b1960ff60a01b19909116600160a01b1716600160a81b17905534801561003257600080fd5b50615f1680620000436000396000f3fe608060405234801561001057600080fd5b50600436106103c55760003560e01c80638d02d9a1116101ff578063c26b1b131161011a578063e9c714f2116100ad578063f851a4401161007c578063f851a44014610ca4578063f8f9da2814610cac578063fca7820b14610cb4578063fe9c44ae14610cd1576103c5565b8063e9c714f214610c38578063f2b3abbd14610c40578063f3fdb15a14610c66578063f5e3c46214610c6e576103c5565b8063dbfe7c19116100e9578063dbfe7c1914610bf2578063dc028ab114610bfa578063dd62ed3e14610c02578063e16d2c3214610c30576103c5565b8063c26b1b1314610b64578063c37f68e214610b6c578063c5ebeaec14610bb8578063db006a7514610bd5576103c5565b8063a9059cbb11610192578063b2a02ff111610161578063b2a02ff114610af8578063b71d1a0c14610b2e578063bd6d894d14610b54578063bf0f1d7b14610b5c576103c5565b8063a9059cbb14610ab4578063aa5af0fd14610ae0578063ac784ddc14610ae8578063ae9d70b014610af0576103c5565b806395dd9193116101ce57806395dd919314610a4c578063a03dce8d14610a72578063a0712d6814610a8f578063a6afed9514610aac576103c5565b80638d02d9a114610a175780638f840ddd14610a1f57806391dd36c614610a2757806395d89b4114610a44576103c5565b8063313ce567116102ef5780635fe3b567116102825780636f307dc3116102515780636f307dc3146109c457806370a08231146109cc57806373acee98146109f2578063852a12e3146109fa576103c5565b80635fe3b5671461098f578063601a0bf11461099757806361feacff146109b45780636c540baf146109bc576103c5565b80634576b5db116102be5780634576b5db146108b557806347bd3718146108db57806356e67728146108e35780635c60da1b14610987576103c5565b8063313ce5671461084c5780633af9e6691461086a5780633b1d21a2146108905780633e94101014610898576103c5565b806317bfdfbc1161036757806323b872dd1161033657806323b872dd146107be5780632608f818146107f457806326782247146108205780632f1069ba14610844576103c5565b806317bfdfbc1461062857806318160ddd1461064e578063182df0f514610656578063219ef65c1461065e576103c5565b80630e752702116103a35780630e7527021461048f5780630f8855e8146104be578063153ab50514610618578063173b990414610620576103c5565b806306fdde03146103ca578063095ea7b3146104475780630a755ec214610487575b600080fd5b6103d2610cd9565b6040805160208082528351818301528351919283929083019185019080838360005b8381101561040c5781810151838201526020016103f4565b50505050905090810190601f1680156104395780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6104736004803603604081101561045d57600080fd5b506001600160a01b038135169060200135610d64565b604080519115158252519081900360200190f35b610473610dd1565b6104ac600480360360208110156104a557600080fd5b5035610de1565b60408051918252519081900360200190f35b61061660048036036101008110156104d557600080fd5b6001600160a01b03823581169260208101359091169160408201359190810190608081016060820135600160201b81111561050f57600080fd5b82018360208201111561052157600080fd5b803590602001918460018302840111600160201b8311171561054257600080fd5b91908080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509295949360208101935035915050600160201b81111561059457600080fd5b8201836020820111156105a657600080fd5b803590602001918460018302840111600160201b831117156105c757600080fd5b91908080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509295505060ff8335169350505060208101359060400135610df7565b005b6106166110fb565b6104ac611140565b6104ac6004803603602081101561063e57600080fd5b50356001600160a01b0316611146565b6104ac61121a565b6104ac611220565b610616600480360361012081101561067557600080fd5b6001600160a01b03823581169260208101358216926040820135909216916060820135919081019060a081016080820135600160201b8111156106b757600080fd5b8201836020820111156106c957600080fd5b803590602001918460018302840111600160201b831117156106ea57600080fd5b91908080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509295949360208101935035915050600160201b81111561073c57600080fd5b82018360208201111561074e57600080fd5b803590602001918460018302840111600160201b8311171561076f57600080fd5b91908080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509295505060ff8335169350505060208101359060400135611283565b610473600480360360608110156107d457600080fd5b506001600160a01b03813581169160208101359091169060400135611326565b6104ac6004803603604081101561080a57600080fd5b506001600160a01b0381351690602001356113ac565b6108286113c2565b604080516001600160a01b039092168252519081900360200190f35b6104736113d6565b6108546113e6565b6040805160ff9092168252519081900360200190f35b6104ac6004803603602081101561088057600080fd5b50356001600160a01b03166113ef565b6104ac6114a5565b6104ac600480360360208110156108ae57600080fd5b50356114b4565b6104ac600480360360208110156108cb57600080fd5b50356001600160a01b03166114bf565b6104ac611608565b610616600480360360208110156108f957600080fd5b810190602081018135600160201b81111561091357600080fd5b82018360208201111561092557600080fd5b803590602001918460018302840111600160201b8311171561094657600080fd5b91908080601f01602080910402602001604051908101604052809392919081815260200183838082843760009201919091525092955061160e945050505050565b610828611654565b610828611663565b6104ac600480360360208110156109ad57600080fd5b5035611672565b6104ac611721565b6104ac611727565b61082861172d565b6104ac600480360360208110156109e257600080fd5b50356001600160a01b031661173c565b6104ac611757565b6104ac60048036036020811015610a1057600080fd5b5035611822565b6104ac61182d565b6104ac611833565b6104ac60048036036020811015610a3d57600080fd5b5035611839565b6103d26118c5565b6104ac60048036036020811015610a6257600080fd5b50356001600160a01b0316611920565b6104ac60048036036020811015610a8857600080fd5b503561197d565b6104ac60048036036020811015610aa557600080fd5b5035611a09565b6104ac611a15565b61047360048036036040811015610aca57600080fd5b506001600160a01b038135169060200135611bc2565b6104ac611c47565b610473611c4d565b6104ac611c52565b6104ac60048036036060811015610b0e57600080fd5b506001600160a01b03813581169160208101359091169060400135611d01565b6104ac60048036036020811015610b4457600080fd5b50356001600160a01b0316611d84565b6104ac611e0e565b6104ac611ede565b6104ac611f54565b610b9260048036036020811015610b8257600080fd5b50356001600160a01b0316612003565b604080519485526020850193909352838301919091526060830152519081900360800190f35b6104ac60048036036020811015610bce57600080fd5b5035612098565b6104ac60048036036020811015610beb57600080fd5b50356120a3565b6104ac6120ae565b6104ac6120b4565b6104ac60048036036040811015610c1857600080fd5b506001600160a01b03813581169160200135166120ba565b6104ac6120e5565b6104ac612154565b6104ac60048036036020811015610c5657600080fd5b50356001600160a01b0316612254565b61082861228e565b6104ac60048036036060811015610c8457600080fd5b506001600160a01b0381358116916020810135916040909101351661229d565b6108286122b5565b6104ac6122c4565b6104ac60048036036020811015610cca57600080fd5b5035612330565b6104736123bc565b6002805460408051602060018416156101000260001901909316849004601f81018490048402820184019092528181529291830182828015610d5c5780601f10610d3157610100808354040283529160200191610d5c565b820191906000526020600020905b815481529060010190602001808311610d3f57829003601f168201915b505050505081565b3360008181526013602090815260408083206001600160a01b03871680855290835281842086905581518681529151939493909284927f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925929081900390910190a360019150505b92915050565b600154600160a81b900460ff1681565b600080610ded836123c1565b509150505b919050565b610dff61247e565b610e3a5760405162461bcd60e51b8152600401808060200182810382526024815260200180615bf36024913960400191505060405180910390fd5b600b54158015610e4a5750600c54155b610e855760405162461bcd60e51b8152600401808060200182810382526023815260200180615c176023913960400191505060405180910390fd5b600786905585610ec65760405162461bcd60e51b8152600401808060200182810382526030815260200180615c3a6030913960400191505060405180910390fd5b6000610ed1896114bf565b90508015610f26576040805162461bcd60e51b815260206004820152601a60248201527f73657474696e6720636f6d7074726f6c6c6572206661696c6564000000000000604482015290519081900360640190fd5b610f2e6124d9565b600b55670de0b6b3a7640000600c55610f46886124dd565b90508015610f855760405162461bcd60e51b8152600401808060200182810382526022815260200180615c6a6022913960400191505060405180910390fd5b8551610f98906002906020890190615a9a565b508451610fac906003906020880190615a9a565b506004805460ff191660ff8616179055610fc583612645565b9050801561101a576040805162461bcd60e51b815260206004820152601d60248201527f73657474696e67207265736572766520666163746f72206661696c6564000000604482015290519081900360640190fd5b611023826126e9565b90508015611078576040805162461bcd60e51b815260206004820152601860248201527f73657474696e672061646d696e20666565206661696c65640000000000000000604482015290519081900360640190fd5b61108861108361278d565b6127dc565b905080156110dd576040805162461bcd60e51b815260206004820152601760248201527f73657474696e67204675736520666565206661696c6564000000000000000000604482015290519081900360640190fd5b50506001805460ff60b01b1916600160b01b17905550505050505050565b61110361247e565b61113e5760405162461bcd60e51b815260040180806020018281038252602d815260200180615c8c602d913960400191505060405180910390fd5b565b600a5481565b600154600090600160b01b900460ff16611194576040805162461bcd60e51b815260206004820152600a6024820152691c994b595b9d195c995960b21b604482015290519081900360640190fd5b6001805460ff60b01b1916905560006111ab611a15565b146111f6576040805162461bcd60e51b81526020600482015260166024820152751858d8dc9d59481a5b9d195c995cdd0819985a5b195960521b604482015290519081900360640190fd5b6111ff82611920565b90505b6001805460ff60b01b1916600160b01b179055919050565b60115481565b600080600061122d612879565b9092509050600082600381111561124057fe5b1461127c5760405162461bcd60e51b8152600401808060200182810382526035815260200180615dd96035913960400191505060405180910390fd5b9150505b90565b6112938888888888888888610df7565b601580546001600160a01b0319166001600160a01b038b81169190911791829055604080516318160ddd60e01b8152905192909116916318160ddd91600480820192602092909190829003018186803b1580156112ef57600080fd5b505afa158015611303573d6000803e3d6000fd5b505050506040513d602081101561131957600080fd5b5050505050505050505050565b600154600090600160b01b900460ff16611374576040805162461bcd60e51b815260206004820152600a6024820152691c994b595b9d195c995960b21b604482015290519081900360640190fd5b6001805460ff60b01b19169055600061138f33868686612930565b1490506001805460ff60b01b1916600160b01b1790559392505050565b6000806113b98484612c3e565b50949350505050565b60045461010090046001600160a01b031681565b600154600160a01b900460ff1681565b60045460ff1681565b60006113f9615b18565b604051806020016040528061140c611e0e565b90526001600160a01b038416600090815260126020526040812054919250908190611438908490612cfd565b9092509050600082600381111561144b57fe5b1461149d576040805162461bcd60e51b815260206004820152601f60248201527f62616c616e636520636f756c64206e6f742062652063616c63756c6174656400604482015290519081900360640190fd5b949350505050565b60006114af612d51565b905090565b6000610dcb82612dd1565b60006114c961247e565b6114e0576114d96001604a612e79565b9050610df2565b60055460408051623f1ee960e11b815290516001600160a01b0392831692851691627e3dd2916004808301926020929190829003018186803b15801561152557600080fd5b505afa158015611539573d6000803e3d6000fd5b505050506040513d602081101561154f57600080fd5b50516115a2576040805162461bcd60e51b815260206004820152601c60248201527f6d61726b6572206d6574686f642072657475726e65642066616c736500000000604482015290519081900360640190fd5b600580546001600160a01b0319166001600160a01b03858116918217909255604080519284168352602083019190915280517f7ac369dbd14fa5ea3f473ed67cc9d598964a77501540ba6751eb0b3decf5870d9281900390910190a160005b9392505050565b600d5481565b61161661247e565b6116515760405162461bcd60e51b815260040180806020018281038252602d815260200180615eb5602d913960400191505060405180910390fd5b50565b6000546001600160a01b031681565b6005546001600160a01b031681565b600154600090600160b01b900460ff166116c0576040805162461bcd60e51b815260206004820152600a6024820152691c994b595b9d195c995960b21b604482015290519081900360640190fd5b6001805460ff60b01b1916905560006116d7611a15565b905080156116fd576116f58160118111156116ee57fe5b603b612e79565b915050611202565b61170683612edf565b9150506001805460ff60b01b1916600160b01b179055919050565b600f5481565b600b5481565b6015546001600160a01b031681565b6001600160a01b031660009081526012602052604090205490565b600154600090600160b01b900460ff166117a5576040805162461bcd60e51b815260206004820152600a6024820152691c994b595b9d195c995960b21b604482015290519081900360640190fd5b6001805460ff60b01b1916905560006117bc611a15565b14611807576040805162461bcd60e51b81526020600482015260166024820152751858d8dc9d59481a5b9d195c995cdd0819985a5b195960521b604482015290519081900360640190fd5b50600d545b6001805460ff60b01b1916600160b01b17905590565b6000610dcb82612fe3565b60085481565b600e5481565b600154600090600160b01b900460ff16611887576040805162461bcd60e51b815260206004820152600a6024820152691c994b595b9d195c995960b21b604482015290519081900360640190fd5b6001805460ff60b01b19169055600061189e611a15565b905080156118bc576116f58160118111156118b557fe5b6052612e79565b611706836126e9565b6003805460408051602060026001851615610100026000190190941693909304601f81018490048402820184019092528181529291830182828015610d5c5780601f10610d3157610100808354040283529160200191610d5c565b600080600061192e84613072565b9092509050600082600381111561194157fe5b146116015760405162461bcd60e51b8152600401808060200182810382526037815260200180615ce46037913960400191505060405180910390fd5b600154600090600160b01b900460ff166119cb576040805162461bcd60e51b815260206004820152600a6024820152691c994b595b9d195c995960b21b604482015290519081900360640190fd5b6001805460ff60b01b1916905560006119e2611a15565b90508015611a00576116f58160118111156119f957fe5b6033612e79565b61170683613126565b600080610ded836131e6565b600080611a206124d9565b905080600b541415611a36576000915050611280565b6000611a40612d51565b600654600d54600f54601054600e54604080516315f2405360e01b815260048101889052602481019590955291019091016044830152519293506000926001600160a01b03909216916315f2405391606480820192602092909190829003018186803b158015611aaf57600080fd5b505afa158015611ac3573d6000803e3d6000fd5b505050506040513d6020811015611ad957600080fd5b5051905065048c27395000811115611b38576040805162461bcd60e51b815260206004820152601c60248201527f626f72726f772072617465206973206162737572646c79206869676800000000604482015290519081900360640190fd5b600080611b4785600b54613275565b90925090506000826003811115611b5a57fe5b14611bac576040805162461bcd60e51b815260206004820152601f60248201527f636f756c64206e6f742063616c63756c61746520626c6f636b2064656c746100604482015290519081900360640190fd5b611bb885858584613298565b9550505050505090565b600154600090600160b01b900460ff16611c10576040805162461bcd60e51b815260206004820152600a6024820152691c994b595b9d195c995960b21b604482015290519081900360640190fd5b6001805460ff60b01b191690556000611c2b33338686612930565b1490506001805460ff60b01b1916600160b01b17905592915050565b600c5481565b600081565b6006546000906001600160a01b031663b8168816611c6e612d51565b600d54600f54601054600e540101600854600954600a5401016040518563ffffffff1660e01b81526004018085815260200184815260200183815260200182815260200194505050505060206040518083038186803b158015611cd057600080fd5b505afa158015611ce4573d6000803e3d6000fd5b505050506040513d6020811015611cfa57600080fd5b5051905090565b600154600090600160b01b900460ff16611d4f576040805162461bcd60e51b815260206004820152600a6024820152691c994b595b9d195c995960b21b604482015290519081900360640190fd5b6001805460ff60b01b19169055611d68338585856134fb565b90506001805460ff60b01b1916600160b01b1790559392505050565b6000611d8e61247e565b611d9e576114d960016051612e79565b600480546001600160a01b03848116610100818102610100600160a81b03198516179094556040805194909304919091168084526020840191909152815190927fca4f2f25d0898edd99413412fb94012f9e54ec8142f9b093e7720646a95b16a992908290030190a16000611601565b600154600090600160b01b900460ff16611e5c576040805162461bcd60e51b815260206004820152600a6024820152691c994b595b9d195c995960b21b604482015290519081900360640190fd5b6001805460ff60b01b191690556000611e73611a15565b14611ebe576040805162461bcd60e51b81526020600482015260166024820152751858d8dc9d59481a5b9d195c995cdd0819985a5b195960521b604482015290519081900360640190fd5b611ec6611220565b90506001805460ff60b01b1916600160b01b17905590565b6000611ee861247e565b611eff57611ef860016050612e79565b9050611280565b600154600160a81b900460ff16611f17576000611ef8565b6001805460ff60a81b191690556040517fc8ed31b431dd871a74f7e15bc645f3dbdd94636e59d7633a4407b044524eb45990600090a160006114af565b600154600090600160b01b900460ff16611fa2576040805162461bcd60e51b815260206004820152600a6024820152691c994b595b9d195c995960b21b604482015290519081900360640190fd5b6001805460ff60b01b191690556000611fb9611a15565b90508015611fdf57611fd7816011811115611fd057fe5b6056612e79565b91505061180c565b611fea61108361278d565b9150506001805460ff60b01b1916600160b01b17905590565b6001600160a01b03811660009081526012602052604081205481908190819081808061202e89613072565b93509050600081600381111561204057fe5b1461205e5760095b9750600096508695508594506120919350505050565b612066612879565b92509050600081600381111561207857fe5b14612084576009612048565b5060009650919450925090505b9193509193565b6000610dcb82613761565b6000610dcb826137ee565b60095481565b60105481565b6001600160a01b03918216600090815260136020908152604080832093909416825291909152205490565b60006120ef61247e565b6120ff57611ef860016050612e79565b600154600160a01b900460ff16612117576000611ef8565b6001805460ff60a01b191690556040517f9f60987413d3c28e8232c3eec2559453cc8c6805ff81501e344a133944113e3590600090a160006114af565b60045460009061010090046001600160a01b031633141580612174575033155b1561218557611ef860016000612e79565b60018054600480546001600160a01b03610100820481166001600160a01b03198516811795869055610100600160a81b031990921690925560408051938316808552949092166020840152815190927ff9ffabca9c8276e99321725bcb43fb076a6c66a54b7f21c4e8146d8519b417dc92908290030190a1600454604080516001600160a01b038481168252610100909304909216602083015280517fca4f2f25d0898edd99413412fb94012f9e54ec8142f9b093e7720646a95b16a99281900390910190a160009250505090565b60008061225f611a15565b905080156122855761227d81601181111561227657fe5b604b612e79565b915050610df2565b611601836124dd565b6006546001600160a01b031681565b6000806122ab858585613876565b5095945050505050565b6001546001600160a01b031681565b6006546000906001600160a01b03166315f240536122e0612d51565b600d54600f54601054600e5401016040518463ffffffff1660e01b815260040180848152602001838152602001828152602001935050505060206040518083038186803b158015611cd057600080fd5b600154600090600160b01b900460ff1661237e576040805162461bcd60e51b815260206004820152600a6024820152691c994b595b9d195c995960b21b604482015290519081900360640190fd5b6001805460ff60b01b191690556000612395611a15565b905080156123b3576116f58160118111156123ac57fe5b6059612e79565b61170683612645565b600181565b6001546000908190600160b01b900460ff16612411576040805162461bcd60e51b815260206004820152600a6024820152691c994b595b9d195c995960b21b604482015290519081900360640190fd5b6001805460ff60b01b191690556000612428611a15565b905080156124535761244681601181111561243f57fe5b6041612e79565b9250600091506124649050565b61245e3333866139bc565b92509250505b6001805460ff60b01b1916600160b01b1790559092909150565b6001546000906001600160a01b0316331480156124a45750600154600160a81b900460ff165b806114af57503373a731585ab05fc9f83555cf9bff8f58ee94e18f851480156114af575050600154600160a01b900460ff1690565b4390565b6000806124e861247e565b6124f85761227d6001604d612e79565b6125006124d9565b600b54146125145761227d600a604c612e79565b600660009054906101000a90046001600160a01b03169050826001600160a01b0316632191f92a6040518163ffffffff1660e01b815260040160206040518083038186803b15801561256557600080fd5b505afa158015612579573d6000803e3d6000fd5b505050506040513d602081101561258f57600080fd5b50516125e2576040805162461bcd60e51b815260206004820152601c60248201527f6d61726b6572206d6574686f642072657475726e65642066616c736500000000604482015290519081900360640190fd5b600680546001600160a01b0319166001600160a01b03858116918217909255604080519284168352602083019190915280517fedffc32e068c7c95dfd4bdfd5c4d939a084d6b11c4199eac8436ed234d72f9269281900390910190a16000611601565b600061264f61247e565b61265f576114d96001605a612e79565b6126676124d9565b600b541461267b576114d9600a605b612e79565b670de0b6b3a7640000600954600854840101111561269f576114d96002605c612e79565b600a805490839055604080518281526020810185905281517faaa68312e2ea9d50e16af5068410ab56e1a1fd06037b1a35664812c30f821460929181900390910190a16000611601565b60006126f361247e565b612703576114d960016053612e79565b61270b6124d9565b600b541461271f576114d9600a6054612e79565b670de0b6b3a764000060095483600a5401011115612743576114d960026055612e79565b6008805490839055604080518281526020810185905281517fcdd0b588250e1398549f79cfdb8217c186688822905d6715b0834ea1c865594a929181900390910190a16000611601565b600073a731585ab05fc9f83555cf9bff8f58ee94e18f856001600160a01b031663dd86fea16040518163ffffffff1660e01b815260040160206040518083038186803b158015611cd057600080fd5b60006009548214156127ef5760006114d9565b6127f76124d9565b600b541461280b576114d9600a6057612e79565b670de0b6b3a764000082600854600a540101111561282f576114d960026058612e79565b6009805490839055604080518281526020810185905281517f92eef861b6533b7d3417f39c2ad7b460eed4e88a32fa3604f30e718b7602e7dc929181900390910190a16000611601565b6011546000908190806128945750506007546000915061292c565b600061289e612d51565b905060006128aa615b18565b60006128c384600d54600f54601054600e540101613e46565b9350905060008160038111156128d557fe5b146128ea5795506000945061292c9350505050565b6128f48386613e92565b92509050600081600381111561290657fe5b1461291b5795506000945061292c9350505050565b505160009550935061292c92505050565b9091565b600554604080516317b9b84b60e31b81523060048201526001600160a01b03868116602483015285811660448301526064820185905291516000938493169163bdcdc25891608480830192602092919082900301818787803b15801561299557600080fd5b505af11580156129a9573d6000803e3d6000fd5b505050506040513d60208110156129bf57600080fd5b5051905080156129de576129d66003605d83613f42565b91505061149d565b836001600160a01b0316856001600160a01b03161415612a04576129d66002605e612e79565b60006001600160a01b038781169087161415612a235750600019612a4b565b506001600160a01b038086166000908152601360209081526040808320938a16835292905220545b600080600080612a5b8589613275565b90945092506000846003811115612a6e57fe5b14612a8c57612a7f6009605e612e79565b965050505050505061149d565b6001600160a01b038a16600090815260126020526040902054612aaf9089613275565b90945091506000846003811115612ac257fe5b14612ad357612a7f6009605f612e79565b6001600160a01b038916600090815260126020526040902054612af69089613fcb565b90945090506000846003811115612b0957fe5b14612b1a57612a7f60096060612e79565b6001600160a01b03808b16600090815260126020526040808220859055918b168152208190556000198514612b72576001600160a01b03808b166000908152601360209081526040808320938f168352929052208390555b886001600160a01b03168a6001600160a01b0316600080516020615d558339815191528a6040518082815260200191505060405180910390a36005546040805163352b4a3f60e11b81523060048201526001600160a01b038d811660248301528c81166044830152606482018c905291519190921691636a56947e91608480830192600092919082900301818387803b158015612c0e57600080fd5b505af1158015612c22573d6000803e3d6000fd5b5060009250612c2f915050565b9b9a5050505050505050505050565b6001546000908190600160b01b900460ff16612c8e576040805162461bcd60e51b815260206004820152600a6024820152691c994b595b9d195c995960b21b604482015290519081900360640190fd5b6001805460ff60b01b191690556000612ca5611a15565b90508015612cd057612cc3816011811115612cbc57fe5b6040612e79565b925060009150612ce19050565b612cdb3386866139bc565b92509250505b6001805460ff60b01b1916600160b01b17905590939092509050565b6000806000612d0a615b18565b612d148686613ff1565b90925090506000826003811115612d2757fe5b14612d385750915060009050612d4a565b6000612d4382614059565b9350935050505b9250929050565b601554604080516370a0823160e01b815230600482015290516000926001600160a01b03169182916370a0823191602480820192602092909190829003018186803b158015612d9f57600080fd5b505afa158015612db3573d6000803e3d6000fd5b505050506040513d6020811015612dc957600080fd5b505191505090565b600154600090600160b01b900460ff16612e1f576040805162461bcd60e51b815260206004820152600a6024820152691c994b595b9d195c995960b21b604482015290519081900360640190fd5b6001805460ff60b01b191690556000612e36611a15565b90508015612e54576116f5816011811115612e4d57fe5b6061612e79565b612e5d83614068565b509150506001805460ff60b01b1916600160b01b179055919050565b60007f45b96fe442630264581b197e84bbada861235052c5a1aadfff9ea4e40a969aa0836011811115612ea857fe5b836063811115612eb457fe5b604080519283526020830191909152600082820152519081900360600190a182601181111561160157fe5b600080612eea61247e565b612efa5761227d6001603c612e79565b612f026124d9565b600b5414612f165761227d600a603e612e79565b82612f1f612d51565b1015612f315761227d600e603d612e79565b600e54831115612f475761227d6002603f612e79565b50600e5482810390811115612f8d5760405162461bcd60e51b8152600401808060200182810382526024815260200180615e6a6024913960400191505060405180910390fd5b600e819055612f9c3384614150565b604080513381526020810185905280820183905290517f3bad0c59cf2f06e7314077049f48a93578cd16f5ef92329f1dab1420a99c177e9181900360600190a16000611601565b600154600090600160b01b900460ff16613031576040805162461bcd60e51b815260206004820152600a6024820152691c994b595b9d195c995960b21b604482015290519081900360640190fd5b6001805460ff60b01b191690556000613048611a15565b90508015613066576116f581601181111561305f57fe5b602a612e79565b611706336000856141d1565b6001600160a01b0381166000908152601460205260408120805482918291829182916130a957506000945084935061312192505050565b6130b98160000154600c54614698565b909450925060008460038111156130cc57fe5b146130e1575091935060009250613121915050565b6130ef8382600101546146d7565b9094509150600084600381111561310257fe5b14613117575091935060009250613121915050565b5060009450925050505b915091565b6000806131316124d9565b600b54146131455761227d600a6035612e79565b8261314e612d51565b10156131605761227d600e6034612e79565b6010548311156131765761227d60026036612e79565b50601054828103908111156131bc5760405162461bcd60e51b8152600401808060200182810382526027815260200180615e8e6027913960400191505060405180910390fd5b60108190556131df73a731585ab05fc9f83555cf9bff8f58ee94e18f8584614150565b6000611601565b6001546000908190600160b01b900460ff16613236576040805162461bcd60e51b815260206004820152600a6024820152691c994b595b9d195c995960b21b604482015290519081900360640190fd5b6001805460ff60b01b19169055600061324d611a15565b9050801561326b5761244681601181111561326457fe5b6020612e79565b61245e3385614702565b60008083831161328c575060009050818303612d4a565b50600390506000612d4a565b6000806132a3615b18565b6000806000806000806132c460405180602001604052808d8152508b613ff1565b909850965060008860038111156132d757fe5b14613303576132f4600960088a60038111156132ef57fe5b613f42565b9850505050505050505061149d565b61330f87600d54612cfd565b9098509550600088600381111561332257fe5b1461333a576132f4600960018a60038111156132ef57fe5b61334686600d54613fcb565b9098509450600088600381111561335957fe5b14613371576132f4600960048a60038111156132ef57fe5b61338e6040518060200160405280600a5481525087600e54614c19565b909850935060008860038111156133a157fe5b146133b9576132f4600960058a60038111156132ef57fe5b6133d6604051806020016040528060095481525087601054614c19565b909850925060008860038111156133e957fe5b14613401576132f4600960068a60038111156132ef57fe5b61341e604051806020016040528060085481525087600f54614c19565b9098509150600088600381111561343157fe5b14613449576132f4600960078a60038111156132ef57fe5b61345887600c54600c54614c19565b9098509050600088600381111561346b57fe5b14613483576132f4600960038a60038111156132ef57fe5b600b8d9055600c819055600d859055600e8490556010839055600f829055604080518d8152602081018890528082018390526060810187905290517f4dec04e750ca11537cabcd8a9eab06494de08da3735bc8871cd41250e190bc049181900360800190a160009d9c50505050505050505050505050565b6005546040805163d02f735160e01b81523060048201526001600160a01b038781166024830152868116604483015285811660648301526084820185905291516000938493169163d02f73519160a480830192602092919082900301818787803b15801561356857600080fd5b505af115801561357c573d6000803e3d6000fd5b505050506040513d602081101561359257600080fd5b5051905080156135a9576129d66003601d83613f42565b846001600160a01b0316846001600160a01b031614156135cf576129d66006601e612e79565b6001600160a01b038416600090815260126020526040812054819081906135f69087613275565b9093509150600083600381111561360957fe5b1461362c576136216009601c8560038111156132ef57fe5b94505050505061149d565b6001600160a01b03881660009081526012602052604090205461364f9087613fcb565b9093509050600083600381111561366257fe5b1461367a576136216009601b8560038111156132ef57fe5b6001600160a01b038088166000818152601260209081526040808320879055938c168083529184902085905583518a815293519193600080516020615d55833981519152929081900390910190a360055460408051636d35bf9160e01b81523060048201526001600160a01b038c811660248301528b811660448301528a81166064830152608482018a905291519190921691636d35bf919160a480830192600092919082900301818387803b15801561373357600080fd5b505af1158015613747573d6000803e3d6000fd5b5060009250613754915050565b9998505050505050505050565b600154600090600160b01b900460ff166137af576040805162461bcd60e51b815260206004820152600a6024820152691c994b595b9d195c995960b21b604482015290519081900360640190fd5b6001805460ff60b01b1916905560006137c6611a15565b905080156137e4576116f58160118111156137dd57fe5b600a612e79565b6117063384614c66565b600154600090600160b01b900460ff1661383c576040805162461bcd60e51b815260206004820152600a6024820152691c994b595b9d195c995960b21b604482015290519081900360640190fd5b6001805460ff60b01b191690556000613853611a15565b9050801561386a576116f581601181111561305f57fe5b611706338460006141d1565b6001546000908190600160b01b900460ff166138c6576040805162461bcd60e51b815260206004820152600a6024820152691c994b595b9d195c995960b21b604482015290519081900360640190fd5b6001805460ff60b01b1916905560006138dd611a15565b90508015613908576138fb8160118111156138f457fe5b6011612e79565b92506000915061399f9050565b836001600160a01b031663a6afed956040518163ffffffff1660e01b8152600401602060405180830381600087803b15801561394357600080fd5b505af1158015613957573d6000803e3d6000fd5b505050506040513d602081101561396d57600080fd5b50519050801561398d576138fb81601181111561398657fe5b6012612e79565b61399933878787615108565b92509250505b6001805460ff60b01b1916600160b01b1790559094909350915050565b60055460408051631200453160e11b81523060048201526001600160a01b0386811660248301528581166044830152606482018590529151600093849384939116916324008a629160848082019260209290919082900301818787803b158015613a2557600080fd5b505af1158015613a39573d6000803e3d6000fd5b505050506040513d6020811015613a4f57600080fd5b505190508015613a7357613a666003604383613f42565b925060009150613e3e9050565b613a7b6124d9565b600b5414613a8f57613a66600a6044612e79565b613a97615b2b565b6001600160a01b0386166000908152601460205260409020600101546060820152613ac186613072565b6080830181905260208301826003811115613ad857fe5b6003811115613ae357fe5b9052506000905081602001516003811115613afa57fe5b14613b2457613b1660096042836020015160038111156132ef57fe5b935060009250613e3e915050565b600019851415613b3d5760808101516040820152613b45565b604081018590525b613b5387826040015161568b565b60e082018190526080820151613b6891613275565b60a0830181905260208301826003811115613b7f57fe5b6003811115613b8a57fe5b9052506000905081602001516003811115613ba157fe5b14613bdd5760405162461bcd60e51b815260040180806020018281038252603a815260200180615d1b603a913960400191505060405180910390fd5b60a081015115613c815760055460a082015160408051631de6c8a560e21b81523060048201526024810192909252516001600160a01b039092169163779b2294916044808201926020929091908290030181600087803b158015613c4057600080fd5b505af1158015613c54573d6000803e3d6000fd5b505050506040513d6020811015613c6a57600080fd5b505191508115613c8157613b166003604384613f42565b613c91600d548260e00151613275565b60c0830181905260208301826003811115613ca857fe5b6003811115613cb357fe5b9052506000905081602001516003811115613cca57fe5b14613d065760405162461bcd60e51b8152600401808060200182810382526031815260200180615d756031913960400191505060405180910390fd5b60a080820180516001600160a01b03808a16600081815260146020908152604091829020948555600c5460019095019490945560c0870151600d81905560e088015195518251948f16855294840192909252828101949094526060820192909252608081019190915290517f1a2a22cb034d26d1854bdc6666a5b91fe25efbbb5dcad3b0355478d6f5c362a1929181900390910190a160055460e0820151606083015160408051631ededc9160e01b81523060048201526001600160a01b038c811660248301528b8116604483015260648201949094526084810192909252519190921691631ededc919160a480830192600092919082900301818387803b158015613e1157600080fd5b505af1158015613e25573d6000803e3d6000fd5b5060009250613e32915050565b8160e001519350935050505b935093915050565b600080600080613e568787613fcb565b90925090506000826003811115613e6957fe5b14613e7a5750915060009050613e3e565b613e848186613275565b935093505050935093915050565b6000613e9c615b18565b600080613eb186670de0b6b3a7640000614698565b90925090506000826003811115613ec457fe5b14613ee357506040805160208101909152600081529092509050612d4a565b600080613ef083886146d7565b90925090506000826003811115613f0357fe5b14613f2557506040805160208101909152600081529094509250612d4a915050565b604080516020810190915290815260009890975095505050505050565b60007f45b96fe442630264581b197e84bbada861235052c5a1aadfff9ea4e40a969aa0846011811115613f7157fe5b846063811115613f7d57fe5b604080519283526020830191909152818101859052519081900360600190a16003846011811115613faa57fe5b14613fc057836011811115613fbb57fe5b61149d565b506103e80192915050565b600080838301848110613fe357600092509050612d4a565b506002915060009050612d4a565b6000613ffb615b18565b60008061400c866000015186614698565b9092509050600082600381111561401f57fe5b1461403e57506040805160208101909152600081529092509050612d4a565b60408051602081019091529081526000969095509350505050565b51670de0b6b3a7640000900490565b6000806000806140766124d9565b600b54146140955761408a600a6062612e79565b935091506131219050565b61409f338661568b565b905080600e54019150600e548210156140ff576040805162461bcd60e51b815260206004820181905260248201527f61646420726573657276657320756e6578706563746564206f766572666c6f77604482015290519081900360640190fd5b600e829055604080513381526020810183905280820184905290517fa91e67c5ea634cd43a12c5a482724b03de01e85ca68702a53d0c2f45cb7c1dc59181900360600190a160009350915050915091565b604080516001600160a01b038416602482015260448082018490528251808303909101815260649091018252602081810180516001600160e01b031663a9059cbb60e01b179052825180840190935260198352781513d2d15397d514905394d1915497d3d55517d19052531151603a1b908301526141cd91615868565b5050565b60008215806141de575081155b6142195760405162461bcd60e51b8152600401808060200182810382526034815260200180615e366034913960400191505060405180910390fd5b614221615b71565b614229612879565b604083018190526020830182600381111561424057fe5b600381111561424b57fe5b905250600090508160200151600381111561426257fe5b146142865761427e6009602e836020015160038111156132ef57fe5b915050611601565b83156143075760608101849052604080516020810182529082015181526142ad9085612cfd565b60808301819052602083018260038111156142c457fe5b60038111156142cf57fe5b90525060009050816020015160038111156142e657fe5b146143025761427e6009602c836020015160038111156132ef57fe5b614380565b6143238360405180602001604052808460400151815250615a29565b606083018190526020830182600381111561433a57fe5b600381111561434557fe5b905250600090508160200151600381111561435c57fe5b146143785761427e6009602d836020015160038111156132ef57fe5b608081018390525b60055460608201516040805163eabe7d9160e01b81523060048201526001600160a01b03898116602483015260448201939093529051600093929092169163eabe7d919160648082019260209290919082900301818787803b1580156143e557600080fd5b505af11580156143f9573d6000803e3d6000fd5b505050506040513d602081101561440f57600080fd5b50519050801561442f576144266003602b83613f42565b92505050611601565b6144376124d9565b600b541461444b57614426600a602f612e79565b61445b6011548360600151613275565b60a084018190526020840182600381111561447257fe5b600381111561447d57fe5b905250600090508260200151600381111561449457fe5b146144b05761442660096031846020015160038111156132ef57fe5b6001600160a01b03861660009081526012602052604090205460608301516144d89190613275565b60c08401819052602084018260038111156144ef57fe5b60038111156144fa57fe5b905250600090508260200151600381111561451157fe5b1461452d5761442660096030846020015160038111156132ef57fe5b816080015161453a612d51565b101561454c57614426600e6032612e79565b61455a868360800151614150565b60a082015160115560c08201516001600160a01b038716600081815260126020908152604091829020939093556060850151815190815290513093600080516020615d55833981519152928290030190a36080820151606080840151604080516001600160a01b038b168152602081019490945283810191909152517fe5b754fb1abb7f01b499791d0b820ae3b6af3424ac1c59768edb53f4ec31a9299281900390910190a160055460808301516060840151604080516351dff98960e01b81523060048201526001600160a01b038b81166024830152604482019490945260648101929092525191909216916351dff98991608480830192600092919082900301818387803b15801561466d57600080fd5b505af1158015614681573d6000803e3d6000fd5b506000925061468e915050565b9695505050505050565b600080836146ab57506000905080612d4a565b838302838582816146b857fe5b04146146cc57506002915060009050612d4a565b600092509050612d4a565b600080826146eb5750600190506000612d4a565b60008385816146f657fe5b04915091509250929050565b60055460408051634ef4c3e160e01b81523060048201526001600160a01b03858116602483015260448201859052915160009384938493911691634ef4c3e19160648082019260209290919082900301818787803b15801561476357600080fd5b505af1158015614777573d6000803e3d6000fd5b505050506040513d602081101561478d57600080fd5b5051905080156147b1576147a46003602183613f42565b925060009150612d4a9050565b6147b96124d9565b600b54146147cd576147a4600a6024612e79565b6147d5615b71565b6147dd612879565b60408301819052602083018260038111156147f457fe5b60038111156147ff57fe5b905250600090508160200151600381111561481657fe5b146148405761483260096023836020015160038111156132ef57fe5b935060009250612d4a915050565b6005546040808301516001600160a01b0389811660009081526012602090815284822054855163112c8c9560e11b815230600482015260248101959095526044850152606484018b905293519190941693632259192a93608480850194919392918390030190829087803b1580156148b757600080fd5b505af11580156148cb573d6000803e3d6000fd5b505050506040513d60208110156148e157600080fd5b5051915081156148f8576148326003602184613f42565b614902868661568b565b60c08201819052604080516020810182529083015181526149239190615a29565b606083018190526020830182600381111561493a57fe5b600381111561494557fe5b905250600090508160200151600381111561495c57fe5b146149ae576040805162461bcd60e51b815260206004820181905260248201527f4d494e545f45584348414e47455f43414c43554c4154494f4e5f4641494c4544604482015290519081900360640190fd5b6149be6011548260600151613fcb565b60808301819052602083018260038111156149d557fe5b60038111156149e057fe5b90525060009050816020015160038111156149f757fe5b14614a335760405162461bcd60e51b8152600401808060200182810382526028815260200180615e0e6028913960400191505060405180910390fd5b6001600160a01b0386166000908152601260205260409020546060820151614a5b9190613fcb565b60a0830181905260208301826003811115614a7257fe5b6003811115614a7d57fe5b9052506000905081602001516003811115614a9457fe5b14614ad05760405162461bcd60e51b815260040180806020018281038252602b815260200180615cb9602b913960400191505060405180910390fd5b608081015160115560a08101516001600160a01b0387166000818152601260209081526040918290209390935560c084015160608086015183519485529484019190915282820193909352517f4c209b5fc8ad50758f13e2e1088ba56a560dff690a1c6fef26394f4c03821c4f929181900390910190a1606081015160408051918252516001600160a01b038816913091600080516020615d558339815191529181900360200190a360055460c08201516060830151604080516341c728b960e01b81523060048201526001600160a01b038b81166024830152604482019490945260648101929092525191909216916341c728b991608480830192600092919082900301818387803b158015614be657600080fd5b505af1158015614bfa573d6000803e3d6000fd5b5060009250614c07915050565b8160c001519350935050509250929050565b6000806000614c26615b18565b614c308787613ff1565b90925090506000826003811115614c4357fe5b14614c545750915060009050613e3e565b613e84614c6082614059565b86613fcb565b6005546040805163368f515360e21b81523060048201526001600160a01b0385811660248301526044820185905291516000938493169163da3d454c91606480830192602092919082900301818787803b158015614cc357600080fd5b505af1158015614cd7573d6000803e3d6000fd5b505050506040513d6020811015614ced57600080fd5b505190508015614d0c57614d046003601083613f42565b915050610dcb565b614d146124d9565b600b5414614d2857614d04600a600c612e79565b6000614d32612d51565b905083811015614d5157614d48600e600b612e79565b92505050610dcb565b614d59615baf565b614d6286613072565b6020830181905282826003811115614d7657fe5b6003811115614d8157fe5b9052506000905081516003811115614d9557fe5b14614dba57614db0600980836000015160038111156132ef57fe5b9350505050610dcb565b614dc8816020015186613fcb565b6040830181905282826003811115614ddc57fe5b6003811115614de757fe5b9052506000905081516003811115614dfb57fe5b14614e1757614db06009600e836000015160038111156132ef57fe5b6005546040808301518151631de6c8a560e21b8152306004820152602481019190915290516001600160a01b039092169163779b2294916044808201926020929091908290030181600087803b158015614e7057600080fd5b505af1158015614e84573d6000803e3d6000fd5b505050506040513d6020811015614e9a57600080fd5b505192508215614eb157614db06003601085613f42565b614ebd600d5486613fcb565b6060830181905282826003811115614ed157fe5b6003811115614edc57fe5b9052506000905081516003811115614ef057fe5b14614f0c57614db06009600d836000015160038111156132ef57fe5b600073a731585ab05fc9f83555cf9bff8f58ee94e18f856001600160a01b031663dfcb48bd6040518163ffffffff1660e01b815260040160206040518083038186803b158015614f5b57600080fd5b505afa158015614f6f573d6000803e3d6000fd5b505050506040513d6020811015614f8557600080fd5b50519050600019811015614ff55760008260600151600014614fce57600f54601054600e540101600d548501038360600151670de0b6b3a76400000281614fc857fe5b04614fd1565b60005b905081811115614ff357614fe760116029612e79565b95505050505050610dcb565b505b614fff8787614150565b604080830180516001600160a01b038a1660008181526014602090815290859020928355600c54600190930192909255606080870151600d819055935185519283529282018b9052818501929092529081019190915290517f13ed6866d4e1ee6da46f845c46d7e54120883d75c5ea9a2dacc1c4ca8984ab809181900360800190a160055460408051635c77860560e01b81523060048201526001600160a01b038a81166024830152604482018a905291519190921691635c77860591606480830192600092919082900301818387803b1580156150dc57600080fd5b505af11580156150f0573d6000803e3d6000fd5b50600092506150fd915050565b979650505050505050565b60055460408051632fe3f38f60e11b81523060048201526001600160a01b0384811660248301528781166044830152868116606483015260848201869052915160009384938493911691635fc7e71e9160a48082019260209290919082900301818787803b15801561517957600080fd5b505af115801561518d573d6000803e3d6000fd5b505050506040513d60208110156151a357600080fd5b5051905080156151c7576151ba6003601483613f42565b9250600091506156829050565b6151cf6124d9565b600b54146151e3576151ba600a6018612e79565b6151eb6124d9565b846001600160a01b0316636c540baf6040518163ffffffff1660e01b815260040160206040518083038186803b15801561522457600080fd5b505afa158015615238573d6000803e3d6000fd5b505050506040513d602081101561524e57600080fd5b505114615261576151ba600a6013612e79565b866001600160a01b0316866001600160a01b03161415615287576151ba60066019612e79565b84615298576151ba60076017612e79565b6000198514156152ae576151ba60076016612e79565b6000806152bc8989896139bc565b909250905081156152ec576152dd8260118111156152d657fe5b601a612e79565b94506000935061568292505050565b6005546040805163c488847b60e01b81523060048201526001600160a01b038981166024830152604482018590528251600094859492169263c488847b926064808301939192829003018186803b15801561534657600080fd5b505afa15801561535a573d6000803e3d6000fd5b505050506040513d604081101561537057600080fd5b508051602090910151909250905081156153bb5760405162461bcd60e51b8152600401808060200182810382526033815260200180615da66033913960400191505060405180910390fd5b80886001600160a01b03166370a082318c6040518263ffffffff1660e01b815260040180826001600160a01b03166001600160a01b0316815260200191505060206040518083038186803b15801561541257600080fd5b505afa158015615426573d6000803e3d6000fd5b505050506040513d602081101561543c57600080fd5b50511015615491576040805162461bcd60e51b815260206004820152601860248201527f4c49515549444154455f5345495a455f544f4f5f4d5543480000000000000000604482015290519081900360640190fd5b60006001600160a01b0389163014156154b7576154b0308d8d856134fb565b9050615541565b6040805163b2a02ff160e01b81526001600160a01b038e811660048301528d81166024830152604482018590529151918b169163b2a02ff1916064808201926020929091908290030181600087803b15801561551257600080fd5b505af1158015615526573d6000803e3d6000fd5b505050506040513d602081101561553c57600080fd5b505190505b801561558b576040805162461bcd60e51b81526020600482015260146024820152731d1bdad95b881cd95a5e9d5c994819985a5b195960621b604482015290519081900360640190fd5b604080516001600160a01b03808f168252808e1660208301528183018790528b1660608201526080810184905290517f298637f684da70674f26509b10f07ec2fbc77a335ab1e7d6215a4b2484d8bb529181900360a00190a1600554604080516347ef3b3b60e01b81523060048201526001600160a01b038c811660248301528f811660448301528e811660648301526084820188905260a48201869052915191909216916347ef3b3b9160c480830192600092919082900301818387803b15801561565657600080fd5b505af115801561566a573d6000803e3d6000fd5b5060009250615677915050565b975092955050505050505b94509492505050565b601554604080516370a0823160e01b8152306004820152905160009283926001600160a01b03909116916370a0823191602480820192602092909190829003018186803b1580156156db57600080fd5b505afa1580156156ef573d6000803e3d6000fd5b505050506040513d602081101561570557600080fd5b5051604080516001600160a01b038716602482015230604482015260648082018790528251808303909101815260849091018252602081810180516001600160e01b03166323b872dd60e01b1790528251808401909352601883527f544f4b454e5f5452414e534645525f494e5f4641494c45440000000000000000908301529192506157929190615868565b601554604080516370a0823160e01b815230600482015290516000926001600160a01b0316916370a08231916024808301926020929190829003018186803b1580156157dd57600080fd5b505afa1580156157f1573d6000803e3d6000fd5b505050506040513d602081101561580757600080fd5b5051905081811015615860576040805162461bcd60e51b815260206004820152601a60248201527f544f4b454e5f5452414e534645525f494e5f4f564552464c4f57000000000000604482015290519081900360640190fd5b039392505050565b60155460405183516000926060926001600160a01b0390911691869190819060208401908083835b602083106158af5780518252601f199092019160209182019101615890565b6001836020036101000a0380198251168184511680821785525050505050509050019150506000604051808303816000865af19150503d8060008114615911576040519150601f19603f3d011682016040523d82523d6000602084013e615916565b606091505b509150915081615979578051156159305780518082602001fd5b6040805162461bcd60e51b81526020600482015260196024820152781513d2d15397d514905394d1915497d3d55517d19052531151603a1b604482015290519081900360640190fd5b805115615a235780806020019051602081101561599557600080fd5b50518390615a215760405162461bcd60e51b81526004018080602001828103825283818151815260200191508051906020019080838360005b838110156159e65781810151838201526020016159ce565b50505050905090810190601f168015615a135780820380516001836020036101000a031916815260200191505b509250505060405180910390fd5b505b50505050565b6000806000615a36615b18565b612d1486866000615a45615b18565b600080615a5a670de0b6b3a764000087614698565b90925090506000826003811115615a6d57fe5b14615a8c57506040805160208101909152600081529092509050612d4a565b612d43818660000151613e92565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10615adb57805160ff1916838001178555615b08565b82800160010185558215615b08579182015b82811115615b08578251825591602001919060010190615aed565b50615b14929150615bd8565b5090565b6040518060200160405280600081525090565b6040805161010081019091528060008152602001600081526020016000815260200160008152602001600081526020016000815260200160008152602001600081525090565b6040805160e0810190915280600081526020016000815260200160008152602001600081526020016000815260200160008152602001600081525090565b604080516080810190915280600081526020016000815260200160008152602001600081525090565b61128091905b80821115615b145760008155600101615bde56fe6f6e6c792061646d696e206d617920696e697469616c697a6520746865206d61726b65746d61726b6574206d6179206f6e6c7920626520696e697469616c697a6564206f6e6365696e697469616c2065786368616e67652072617465206d7573742062652067726561746572207468616e207a65726f2e73657474696e6720696e7465726573742072617465206d6f64656c206661696c65646f6e6c79207468652061646d696e206d61792063616c6c205f72657369676e496d706c656d656e746174696f6e4d494e545f4e45575f4143434f554e545f42414c414e43455f43414c43554c4154494f4e5f4641494c4544626f72726f7742616c616e636553746f7265643a20626f72726f7742616c616e636553746f726564496e7465726e616c206661696c656452455041595f424f52524f575f4e45575f4143434f554e545f424f52524f575f42414c414e43455f43414c43554c4154494f4e5f4641494c4544ddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef52455041595f424f52524f575f4e45575f544f54414c5f42414c414e43455f43414c43554c4154494f4e5f4641494c45444c49515549444154455f434f4d5054524f4c4c45525f43414c43554c4154455f414d4f554e545f5345495a455f4641494c454465786368616e67655261746553746f7265643a2065786368616e67655261746553746f726564496e7465726e616c206661696c65644d494e545f4e45575f544f54414c5f535550504c595f43414c43554c4154494f4e5f4641494c45446f6e65206f662072656465656d546f6b656e73496e206f722072656465656d416d6f756e74496e206d757374206265207a65726f72656475636520726573657276657320756e657870656374656420756e646572666c6f7777697468647261772046757365206665657320756e657870656374656420756e646572666c6f776f6e6c79207468652061646d696e206d61792063616c6c205f6265636f6d65496d706c656d656e746174696f6ea265627a7a723158201f9d3d8ae6ea2dba366df799543bdc4d76d3a1b0ab7b863fb70666fc115e324864736f6c63430005110032"};

// LiquidationStrategy enum
const LIQUIDATION_STRATEGIES = {
  CurveLpToken: "0xc6e7DF5E7b4f2A278906862b61205850344D4e7d",
  CurveLiquidityGaugeV2: "0x59b670e9fA9D0A427751Af201D676719a970857b",
  UniswapLpToken: "0xa85233C63b9Ee964Add6F2cffe00Fd84eb32338f",
  YearnYVaultV1: "0x4ed7c70F96B99c776995fB64377f0d4aB3B0e1C1",
  YearnYVaultV2: "0x322813Fd9A801c5507c9de605d63CEA4f2CE6c44",
  BalancerPoolToken: "0x4A679253410272dd5232B3Ff7cF5dbB88f295319",
  SynthetixSynth: "0x1613beB3B2C4f22Ee086B2b38C1476A3cE7f78E8",
  PoolTogether: "0x82e01223d51Eb87e16A03E24687EDF0F294da6f1",
  CurveSwap: "0x2bdCC0de6bE1f7D2ee689a0342D76F52E8EFABa3"
};

// Supported Uniswap V2 protocols
const UNISWAP_V2_PROTOCOLS = {
  "Uniswap": {
    router: "0x7a250d5630B4cF539739dF2C5dAcb4c659F2488D",
    factory: "0x5c69bee701ef814a2b6a3edd4b1652cb9cc5aa6f"
  },
  "SushiSwap": {
    router: "0xd9e1ce17f2641f24ae83637ab66a2cca9c378b9f",
    factory: "0xc0aee478e3658e2610c5f7a4a2e1777ce9e4f2ac"
  }
}

// Liquidation strategy functions
async function getUniswapV2RouterByBestWethLiquidity(token) {
  // Get best Uniswap market for this token
  var bestUniswapV2RouterForToken, bestUniswapLiquidityForToken = Fuse.Web3.utils.toBN(0);
  var uniswapV2FactoryAbi = [{"constant":true,"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"}],"name":"getPair","outputs":[{"internalType":"address","name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"}];
  var uniswapV2PairAbi = [{"constant":true,"inputs":[],"name":"getReserves","outputs":[{"internalType":"uint112","name":"_reserve0","type":"uint112"},{"internalType":"uint112","name":"_reserve1","type":"uint112"},{"internalType":"uint32","name":"_blockTimestampLast","type":"uint32"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"token0","outputs":[{"internalType":"address","name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"}];
  for (const uniswapV2 of Object.values(UNISWAP_V2_PROTOCOLS)) {
    var uniswapV2Factory = new fuse.web3.eth.Contract(uniswapV2FactoryAbi, uniswapV2.factory);
    var uniswapV2Pair = await uniswapV2Factory.methods.getPair(token, Fuse.WETH_ADDRESS).call();
    if (uniswapV2Pair == "0x0000000000000000000000000000000000000000") continue;
    uniswapV2Pair = new fuse.web3.eth.Contract(uniswapV2PairAbi, uniswapV2Pair);
    var reserves = await uniswapV2Pair.methods.getReserves().call();
    var wethLiquidity = Fuse.Web3.utils.toBN(reserves[(await uniswapV2Pair.methods.token0().call()).toLowerCase() == Fuse.WETH_ADDRESS.toLowerCase() ? "0" : "1"])
    if (wethLiquidity.gt(bestUniswapLiquidityForToken)) {
      bestUniswapV2RouterForToken = uniswapV2.router;
      bestUniswapLiquidityForToken = wethLiquidity;
    }
  }
  return [bestUniswapV2RouterForToken, bestUniswapLiquidityForToken];
}

async function getLiquidationStrategyData(token, strategy) {
  if (strategy == "CurveLiquidityGaugeV2") {
    // Get coins underlying LP token underling gauge
    var gaugeAbi = [{"name":"lp_token","outputs":[{"type":"address","name":""}],"inputs":[],"stateMutability":"view","type":"function","gas":1871}];
    var gauge = new fuse.web3.eth.Contract(gaugeAbi, token);
    token = await gauge.methods.lp_token().call();
    strategy = "CurveLpToken";
  }

  if (strategy == "CurveLpToken") {
    // Get Curve pool coins
    var registryAbi = [{"name":"get_coins","outputs":[{"type":"address[8]","name":""}],"inputs":[{"type":"address","name":"_pool"}],"stateMutability":"view","type":"function","gas":12285},{"name":"get_pool_from_lp_token","outputs":[{"type":"address","name":""}],"inputs":[{"type":"address","name":"arg0"}],"stateMutability":"view","type":"function","gas":2446}];
    var registry = new fuse.web3.eth.Contract(registryAbi, "0x7D86446dDb609eD0F5f8684AcF30380a356b2B4c");
    var pool = await registry.methods.get_pool_from_lp_token(token).call();
    var coins = await registry.methods.get_coins(pool).call();

    // Get ideal output coin and Uniswap market by best swap liquidity
    var bestCurveCoinIndex, bestUnderlying, bestUniswapV2Router, bestUniswapLiquidity = 0;

    for (var i = 0; i < coins.length; i++) {
      // Break if we have iterated through all coins
      if (coins[i] == "0x0000000000000000000000000000000000000000") break;

      // Break if coin is ETH or WETH
      if (coins[i].toLowerCase() == "0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE" || coins[i].toLowerCase() == Fuse.WETH_ADDRESS.toLowerCase()) {
        bestUniswapV2Router = UNISWAP_V2_PROTOCOLS.Uniswap.router;
        bestCurveCoinIndex = i;
        bestUnderlying = coins[i];
        break;
      }

      // Get best Uniswap market for this token
      var [bestUniswapV2RouterForToken, bestUniswapLiquidityForToken] = await getUniswapV2RouterByBestWethLiquidity(coins[i]);

      // If this token's best Uniswap liquidity is better than the rest, use it
      if (bestUniswapLiquidityForToken > bestUniswapLiquidity) {
        bestCurveCoinIndex = i;
        bestUnderlying = coins[i];
        bestUniswapV2Router = bestUniswapV2RouterForToken;
        bestUniswapLiquidity = bestUniswapLiquidityForToken;
      }
    }

    // Return strategy data and Uniswap V2 router
    return [fuse.web3.eth.abi.encodeParameters(['uint8', 'address'], [bestCurveCoinIndex, bestUnderlying]), bestUniswapV2Router];
  }

  if (strategy == "CurveSwap") {
    // Get Curve pool for token => WETH
    var registryAbi = [{"name":"find_pool_for_coins","outputs":[{"type":"address","name":""}],"inputs":[{"type":"address","name":"_from"},{"type":"address","name":"_to"}],"stateMutability":"view","type":"function"},{"name":"get_coin_indices","outputs":[{"type":"int128","name":""},{"type":"int128","name":""},{"type":"bool","name":""}],"inputs":[{"type":"address","name":"_pool"},{"type":"address","name":"_from"},{"type":"address","name":"_to"}],"stateMutability":"view","type":"function","gas":27456}];
    var registry = new fuse.web3.eth.Contract(registryAbi, "0x7D86446dDb609eD0F5f8684AcF30380a356b2B4c");
    var pool = await registry.methods.find_pool_for_coins(token, "0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE").call();
    var indices = await registry.methods.get_coin_indices(pool, token, "0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE").call();

    // Return strategy data and Uniswap V2 router
    return [fuse.web3.eth.abi.encodeParameters(['address', 'int128', 'int128', 'address'], [pool, indices["0"], indices["1"], "0x0000000000000000000000000000000000000000"]), UNISWAP_V2_PROTOCOLS.Uniswap.router];
  }
}

// Assets to be added to pool
const testAssetFixtures = [
  { name: "Fuse ETH", symbol: "f123-ETH", underlying: "0x0000000000000000000000000000000000000000", price: Fuse.Web3.utils.toBN(1e18) },
  { name: "Fuse USDC", symbol: "f123-USDC", underlying: "0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48", price: "421407501053518000000000000" },
  { name: "Fuse DAI", symbol: "f123-DAI", underlying: "0x6b175474e89094c44da98b954eedeac495271d0f", price: "421407501053518" },
  { name: "Fuse linkCRV", symbol: "f123-linkCRV", underlying: "0xcee60cfa923170e4f8204ae08b4fa6a3f5656f3a", price: "14810827631962988" },
  { name: "Fuse linkCRV-gauge", symbol: "f123-linkCRV-gauge", underlying: "0xfd4d8a17df4c27c1dd245d153ccf4499e806c87d", price: "14810827631962988" },
  { name: "Fuse yUSDC", symbol: "f123-yUSDC", underlying: "0x597aD1e0c13Bfe8025993D9e79C69E1c0233522e", price: "461407501053518000000000000" }, // yVault V1
  { name: "Fuse yvDAI", symbol: "f123-yvDAI", underlying: "0x19D3364A399d251E894aC732651be8B0E4e85001", price: "421407501053518" }, // yVault V2
  { name: "Fuse Uniswap DAI-ETH", symbol: "f123u-DAI-ETH", underlying: "0xa478c2975ab1ea89e8196811f51a7b7ade33eb11", price: "42140750105351800" },
  { name: "Fuse Balancer WETH-50-WBTC-50", symbol: "f123b-WETH-50-WBTC-50", underlying: "0x1eff8af5d577060ba4ac8a29a13525bb0ee2a3d5", price: "100000000000000000000" }, // BPT WETH-WBTC
  { name: "Fuse yvlinkCRV", symbol: "f123-yvlinkCRV", underlying: "0x96Ea6AF74Af09522fCB4c28C269C26F59a31ced6", price: "14810827631962988" }, // crvLINK yVault V1
  { name: "Fuse yvCurve-sETH", symbol: "f123-yvCurve-sETH", underlying: "0x986b4AFF588a109c09B50A03f42E4110E29D353F", price: "1879096400000000000" }, // eCRV yVault V2
  { name: "Fuse sEUR", symbol: "f123-sEUR", underlying: "0xd71ecff9342a5ced620049e616c5035f1db98620", price: "421407501053518" },
  { name: "Fuse PcUSDC", symbol: "f123-PcUSDC", underlying: "0xd81b1a8b1ad00baa2d6609e0bae28a38713872f7", price: "421407501053518000000000000" },
  { name: "Fuse stETH", symbol: "f123-stETH", underlying: "0xae7ab96520de3a18e5e111b5eaab095312d7fe84", price: "1000000000000000000" }
];

describe('FuseSafeLiquidator', function() {
  this.timeout(30000);
  var accounts, assetAddresses, comptroller, simplePriceOracle;

  before(async function() {
    this.timeout(60000);
    accounts = ["0x45D54B22582c79c8Fb8f4c4F2663ef54944f397a", "0x1Eeb75CFad36EDb6C996f7809f30952B0CA0B5B9", "0x10dB6Bce3F2AE1589ec91A872213DAE59697967a", "0x80845058350b8c3df5c3015d8a717d64b3bf9267", "0x43b2e377e60305df3e23e1dbf9df2c0f2ba44cda", "0x62e41b1185023bcc14a465d350e1dde341557925"];

    // Impersonate accounts
    if (process.env.HARDHAT) for (const account of accounts) await impersonateAccount(account);

    // Whitelist accounts[0] as deployer
    await fuse.contracts.FusePoolDirectory.methods._whitelistDeployers([accounts[0]]).send({ from: "0x10dB6Bce3F2AE1589ec91A872213DAE59697967a" });

    // _setPoolLimits
    // TODO: Make this work without having to fork from block 12085726
    await fuse.contracts.FuseFeeDistributor.methods._setPoolLimits(Fuse.Web3.utils.toBN(0), Fuse.Web3.utils.toBN(2).pow(Fuse.Web3.utils.toBN(256)).subn(1), Fuse.Web3.utils.toBN(2).pow(Fuse.Web3.utils.toBN(256)).subn(1)).send({ from: "0x10dB6Bce3F2AE1589ec91A872213DAE59697967a" });

    // Send tokens to accounts[0]
    var token = new fuse.web3.eth.Contract(erc20Abi, "0xd81b1a8b1ad00baa2d6609e0bae28a38713872f7");
    var amount = Fuse.Web3.utils.toBN(10e6);
    if (Fuse.Web3.utils.toBN(await token.methods.balanceOf(accounts[0]).call()).lt(amount)) await token.methods.transfer(accounts[0], amount).send({ from: "0x80845058350b8c3df5c3015d8a717d64b3bf9267" }); // PcUSDC
    var token = new fuse.web3.eth.Contract(erc20Abi, "0xd71ecff9342a5ced620049e616c5035f1db98620");
    var amount = Fuse.Web3.utils.toBN(10e18);
    if (Fuse.Web3.utils.toBN(await token.methods.balanceOf(accounts[0]).call()).lt(amount)) await token.methods.transfer(accounts[0], "10000000000000000000000").send({ from: "0x43b2e377e60305df3e23e1dbf9df2c0f2ba44cda" }); // sEUR
    var token = new fuse.web3.eth.Contract(erc20Abi, "0xae7ab96520de3a18e5e111b5eaab095312d7fe84");
    var amount = Fuse.Web3.utils.toBN(10e18);
    if (Fuse.Web3.utils.toBN(await token.methods.balanceOf(accounts[0]).call()).lt(amount)) await token.methods.transfer(accounts[0], "10000000000000000000000").send({ from: "0x62e41b1185023bcc14a465d350e1dde341557925" }); // stETH

    // Deploy pool
    var [poolAddress, priceOracleAddress] = await deployPool({ priceOracle: "SimplePriceOracle" }, { from: accounts[0], gasPrice: "0", gas: 10e6 });
    comptroller = new fuse.web3.eth.Contract(JSON.parse(fuse.compoundContracts["contracts/Comptroller.sol:Comptroller"].abi), poolAddress);

    // Set initial token prices
    simplePriceOracle = new fuse.web3.eth.Contract(JSON.parse(fuse.compoundContracts["contracts/SimplePriceOracle.sol:SimplePriceOracle"].abi), priceOracleAddress);
    for (const conf of testAssetFixtures) await simplePriceOracle.methods.setDirectPrice(conf.underlying, conf.price).send({ from: accounts[0], gasPrice: "0", gas: 10e6 }); 

    // Deploy assets
    assetAddresses = {};
    for (const conf of testAssetFixtures) assetAddresses[conf.underlying.toLowerCase()] = await deployAsset({ comptroller: poolAddress, ...conf }, undefined, undefined, undefined, { from: accounts[0], gasPrice: "0", gas: 10e6 }, true);
  });

  async function setupUnhealthyEthBorrowWithTokenCollateral(tokenCollateral) {
    // Default token collateral to DAI
    if (tokenCollateral === undefined) tokenCollateral = "0x6b175474e89094c44da98b954eedeac495271d0f";
    var originalPrice = testAssetFixtures.find(item => tokenCollateral.toLowerCase() === item.underlying.toLowerCase()).price;

    // Supply token collateral
    var token = new fuse.web3.eth.Contract(erc20Abi, tokenCollateral);
    var cToken = new fuse.web3.eth.Contract(cErc20Abi, assetAddresses[tokenCollateral.toLowerCase()]);
    await token.methods.approve(cToken.options.address, Fuse.Web3.utils.toBN(2).pow(Fuse.Web3.utils.toBN(256)).subn(1)).send({ from: accounts[0], gasPrice: "0", gas: 10e6 });
    await cToken.methods.mint(Fuse.Web3.utils.toBN(3e14).mul(Fuse.Web3.utils.toBN(1e18)).div(Fuse.Web3.utils.toBN(originalPrice))).send({ from: accounts[0], gasPrice: "0", gas: 10e6 });

    // Supply 0.001 ETH from other account
    var cToken = new fuse.web3.eth.Contract(cEtherAbi, assetAddresses["0x0000000000000000000000000000000000000000"]);
    await cToken.methods.mint().send({ from: accounts[1], gas: 5e6, gasPrice: "0", value: Fuse.Web3.utils.toBN(1e15) });

    // Borrow 0.0001 ETH using token collateral
    await comptroller.methods.enterMarkets([assetAddresses[tokenCollateral.toLowerCase()]]).send({ from: accounts[0], gasPrice: "0", gas: 10e6 });
    await cToken.methods.borrow(Fuse.Web3.utils.toBN(1e14)).send({ from: accounts[0], gasPrice: "0", gas: 10e6 });

    // Set price of token collateral to 1/10th of what it was
    await simplePriceOracle.methods.setDirectPrice(tokenCollateral, Fuse.Web3.utils.toBN(originalPrice).divn(10)).send({ from: accounts[0], gasPrice: "0", gas: 10e6 });
  }

  async function setupUnhealthyTokenBorrowWithEthCollateral() {
    // Supply ETH collateral
    var cToken = new fuse.web3.eth.Contract(cEtherAbi, assetAddresses["0x0000000000000000000000000000000000000000"]);
    await cToken.methods.mint().send({ from: accounts[0], gasPrice: "0", gas: 10e6, value: Fuse.Web3.utils.toBN(1e14) });

    // Supply DAI from other account
    var token = new fuse.web3.eth.Contract(erc20Abi, "0x6b175474e89094c44da98b954eedeac495271d0f");
    var cToken = new fuse.web3.eth.Contract(cErc20Abi, assetAddresses["0x6b175474e89094c44da98b954eedeac495271d0f"]);
    await token.methods.approve(cToken.options.address, Fuse.Web3.utils.toBN(5e17)).send({ from: accounts[1], gas: 5e6, gasPrice: "0" });
    await cToken.methods.mint(Fuse.Web3.utils.toBN(5e17)).send({ from: accounts[1], gas: 5e6, gasPrice: "0" });

    // Borrow DAI using ETH as collateral
    await comptroller.methods.enterMarkets([assetAddresses["0x0000000000000000000000000000000000000000"]]).send({ from: accounts[0], gasPrice: "0", gas: 10e6 });
    await cToken.methods.borrow(Fuse.Web3.utils.toBN(1e17)).send({ from: accounts[0], gasPrice: "0", gas: 10e6 });

    // Set price of ETH collateral to 1/10th of what it was
    await simplePriceOracle.methods.setDirectPrice("0x0000000000000000000000000000000000000000", Fuse.Web3.utils.toBN(1e17)).send({ from: accounts[0], gasPrice: "0", gas: 10e6 });
  }

  async function setupUnhealthyTokenBorrowWithTokenCollateral(tokenCollateral) {
    // Default token collateral to DAI
    if (tokenCollateral === undefined) tokenCollateral = "0x6b175474e89094c44da98b954eedeac495271d0f";

    // Get token collateral price
    var originalPrice = testAssetFixtures.find(item => tokenCollateral.toLowerCase() === item.underlying.toLowerCase()).price;

    // Supply token collateral
    var token = new fuse.web3.eth.Contract(erc20Abi, tokenCollateral);
    var cToken = new fuse.web3.eth.Contract(cErc20Abi, assetAddresses[tokenCollateral.toLowerCase()]);
    await token.methods.approve(cToken.options.address, Fuse.Web3.utils.toBN(2).pow(Fuse.Web3.utils.toBN(256)).subn(1)).send({ from: accounts[0], gasPrice: "0", gas: 10e6 });
    await cToken.methods.mint(Fuse.Web3.utils.toBN(1e14).mul(Fuse.Web3.utils.toBN(1e18)).div(Fuse.Web3.utils.toBN(originalPrice))).send({ from: accounts[0], gasPrice: "0", gas: 10e6 });

    // Supply USDC from other account
    var token = new fuse.web3.eth.Contract(erc20Abi, "0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48");
    var cToken = new fuse.web3.eth.Contract(cErc20Abi, assetAddresses["0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48"]);
    await token.methods.approve(cToken.options.address, Fuse.Web3.utils.toBN(1e6)).send({ from: accounts[1], gas: 5e6, gasPrice: "0" });
    await cToken.methods.mint(Fuse.Web3.utils.toBN(1e6)).send({ from: accounts[1], gas: 5e6, gasPrice: "0" });

    // Borrow USDC using token collateral
    await comptroller.methods.enterMarkets([assetAddresses[tokenCollateral.toLowerCase()]]).send({ from: accounts[0], gasPrice: "0", gas: 10e6 });
    await cToken.methods.borrow(Fuse.Web3.utils.toBN(1e5)).send({ from: accounts[0], gasPrice: "0", gas: 10e6 });

    // Set price of DAI collateral to 1/10th of what it was
    await simplePriceOracle.methods.setDirectPrice(tokenCollateral, Fuse.Web3.utils.toBN(originalPrice).divn(10)).send({ from: accounts[0], gasPrice: "0", gas: 10e6 });
  }

  async function setupAndLiquidateUnhealthyEthBorrowWithTokenCollateral(exchangeTo, flashLoan, tokenCollateral, liquidationStrategy, strategyData, uniswapV2RouterForCollateral) {
    // Default token collateral to DAI
    if (tokenCollateral === undefined) tokenCollateral = "0x6b175474e89094c44da98b954eedeac495271d0f";

    // Setup unhealthy ETH borrow with token collateral
    await setupUnhealthyEthBorrowWithTokenCollateral(tokenCollateral);

    // Defaults
    if (exchangeTo === undefined || exchangeTo === null) exchangeTo = tokenCollateral;
    if (liquidationStrategy === undefined) liquidationStrategy = [];
    else if (typeof liquidationStrategy == "string") liquidationStrategy = [LIQUIDATION_STRATEGIES[liquidationStrategy]];
    else for (var i = 0; i < liquidationStrategy.length; i++) liquidationStrategy[i] = LIQUIDATION_STRATEGIES[liquidationStrategy[i]];
    if (strategyData === undefined || strategyData === "0x0") strategyData = Array(liquidationStrategy.length).fill("0x0");
    else if (typeof strategyData == "string") strategyData = [strategyData];
    if (uniswapV2RouterForCollateral === undefined) uniswapV2RouterForCollateral = UNISWAP_V2_PROTOCOLS.Uniswap.router;

    // Check balance before liquidation
    const liquidatorBalanceBeforeLiquidation = exchangeTo === "0x0000000000000000000000000000000000000000" ? Fuse.Web3.utils.toBN(await fuse.web3.eth.getBalance(accounts[0])) : Fuse.Web3.utils.toBN(await (new fuse.web3.eth.Contract(erc20Abi, exchangeTo)).methods.balanceOf(accounts[0]).call());

    // Liquidate borrow
    var repayAmount = Fuse.Web3.utils.toBN(1e13);
    await (flashLoan ? fuse.contracts.FuseSafeLiquidator.methods.safeLiquidateToEthWithFlashLoan(accounts[0], repayAmount, assetAddresses["0x0000000000000000000000000000000000000000"], assetAddresses[tokenCollateral.toLowerCase()], 0, exchangeTo, uniswapV2RouterForCollateral, liquidationStrategy, strategyData, 0).send({ from: accounts[0], gasPrice: "0", gas: 10e6 }) : fuse.contracts.FuseSafeLiquidator.methods.safeLiquidate(accounts[0], assetAddresses["0x0000000000000000000000000000000000000000"], assetAddresses[tokenCollateral.toLowerCase()], 0, exchangeTo, uniswapV2RouterForCollateral, liquidationStrategy, strategyData).send({ from: accounts[0], gasPrice: "0", gas: 10e6, value: repayAmount }));

    // Assert balance after liquidation > balance before liquidation
    const liquidatorBalanceAfterLiquidation = exchangeTo === "0x0000000000000000000000000000000000000000" ? Fuse.Web3.utils.toBN(await fuse.web3.eth.getBalance(accounts[0])) : Fuse.Web3.utils.toBN(await (new fuse.web3.eth.Contract(erc20Abi, exchangeTo)).methods.balanceOf(accounts[0]).call());
    assert(!flashLoan && exchangeTo === "0x0000000000000000000000000000000000000000" ? liquidatorBalanceAfterLiquidation.gt(liquidatorBalanceBeforeLiquidation.sub(repayAmount)) : liquidatorBalanceAfterLiquidation.gt(liquidatorBalanceBeforeLiquidation)); // Factor in repaid ETH if not supplying own capital
  }

  async function setupAndLiquidateUnhealthyTokenBorrowWithEthCollateral(exchangeTo, flashLoan) {
    // Setup unhealthy token borrow with ETH collateral
    await setupUnhealthyTokenBorrowWithEthCollateral();

    // Default profit target
    if (exchangeTo === undefined || exchangeTo === null) exchangeTo = "0x0000000000000000000000000000000000000000";

    // Check balance before liquidation
    const liquidatorBalanceBeforeLiquidation = exchangeTo === "0x0000000000000000000000000000000000000000" ? Fuse.Web3.utils.toBN(await fuse.web3.eth.getBalance(accounts[0])) : Fuse.Web3.utils.toBN(await (new fuse.web3.eth.Contract(erc20Abi, exchangeTo)).methods.balanceOf(accounts[0]).call());

    // Liquidate borrow
    if (flashLoan) await fuse.contracts.FuseSafeLiquidator.methods.safeLiquidateToTokensWithFlashLoan(accounts[0], Fuse.Web3.utils.toBN(1e16), assetAddresses["0x6b175474e89094c44da98b954eedeac495271d0f"], assetAddresses["0x0000000000000000000000000000000000000000"], 0, exchangeTo, UNISWAP_V2_PROTOCOLS.Uniswap.router, UNISWAP_V2_PROTOCOLS.Uniswap.router, ["0x0000000000000000000000000000000000000000"], ["0x0"], 0).send({ from: accounts[0], gasPrice: "0", gas: 10e6 });
    else {
      var token = new fuse.web3.eth.Contract(erc20Abi, "0x6b175474e89094c44da98b954eedeac495271d0f");
      await token.methods.approve(fuse.contracts.FuseSafeLiquidator.options.address, Fuse.Web3.utils.toBN(1e16)).send({ from: accounts[0], gasPrice: "0", gas: 10e6 });
      await fuse.contracts.FuseSafeLiquidator.methods.safeLiquidate(accounts[0], Fuse.Web3.utils.toBN(1e16), assetAddresses["0x6b175474e89094c44da98b954eedeac495271d0f"], assetAddresses["0x0000000000000000000000000000000000000000"], 0, exchangeTo, UNISWAP_V2_PROTOCOLS.Uniswap.router, ["0x0000000000000000000000000000000000000000"], ["0x0"]).send({ from: accounts[0], gasPrice: "0", gas: 10e6 });
    }

    // Assert balance after liquidation > balance before liquidation
    const liquidatorBalanceAfterLiquidation = exchangeTo === "0x0000000000000000000000000000000000000000" ? Fuse.Web3.utils.toBN(await fuse.web3.eth.getBalance(accounts[0])) : Fuse.Web3.utils.toBN(await (new fuse.web3.eth.Contract(erc20Abi, exchangeTo)).methods.balanceOf(accounts[0]).call());
    assert(liquidatorBalanceAfterLiquidation.gt(liquidatorBalanceBeforeLiquidation));
  }

  async function setupAndLiquidateUnhealthyTokenBorrowWithTokenCollateral(exchangeTo, flashLoan, tokenCollateral, liquidationStrategy, strategyData, uniswapV2RouterForCollateral) {
    // Default token collateral to DAI
    if (tokenCollateral === undefined) tokenCollateral = "0x6b175474e89094c44da98b954eedeac495271d0f";

    // Setup unhealthy ETH borrow with token collateral
    await setupUnhealthyTokenBorrowWithTokenCollateral(tokenCollateral);

    // Defaults
    if (exchangeTo === undefined || exchangeTo === null) exchangeTo = tokenCollateral;
    if (liquidationStrategy === undefined) liquidationStrategy = [];
    else if (typeof liquidationStrategy == "string") liquidationStrategy = [LIQUIDATION_STRATEGIES[liquidationStrategy]];
    else for (var i = 0; i < liquidationStrategy.length; i++) liquidationStrategy[i] = LIQUIDATION_STRATEGIES[liquidationStrategy[i]];
    if (strategyData === undefined || strategyData === "0x0") strategyData = Array(liquidationStrategy.length).fill("0x0");
    else if (typeof strategyData == "string") strategyData = [strategyData];
    if (uniswapV2RouterForCollateral === undefined) uniswapV2RouterForCollateral = UNISWAP_V2_PROTOCOLS.Uniswap.router;

    // Check balance before liquidation
    const liquidatorBalanceBeforeLiquidation = exchangeTo === "0x0000000000000000000000000000000000000000" ? Fuse.Web3.utils.toBN(await fuse.web3.eth.getBalance(accounts[0])) : Fuse.Web3.utils.toBN(await (new fuse.web3.eth.Contract(erc20Abi, exchangeTo)).methods.balanceOf(accounts[0]).call());

    // Liquidate borrow
    if (flashLoan) await fuse.contracts.FuseSafeLiquidator.methods.safeLiquidateToTokensWithFlashLoan(accounts[0], Fuse.Web3.utils.toBN(1e4), assetAddresses["0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48"], assetAddresses[tokenCollateral.toLowerCase()], 0, exchangeTo, UNISWAP_V2_PROTOCOLS.Uniswap.router, uniswapV2RouterForCollateral, liquidationStrategy, strategyData, 0).send({ from: accounts[0], gasPrice: "0", gas: 10e6 });
    else {
      var token = new fuse.web3.eth.Contract(erc20Abi, "0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48");
      await token.methods.approve(fuse.contracts.FuseSafeLiquidator.options.address, Fuse.Web3.utils.toBN(1e4)).send({ from: accounts[0], gasPrice: "0", gas: 10e6 });
      await fuse.contracts.FuseSafeLiquidator.methods.safeLiquidate(accounts[0], Fuse.Web3.utils.toBN(1e4), assetAddresses["0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48"], assetAddresses[tokenCollateral.toLowerCase()], 0, exchangeTo, uniswapV2RouterForCollateral, liquidationStrategy, strategyData).send({ from: accounts[0], gasPrice: "0", gas: 10e6 });
    }

    // Assert balance after liquidation > balance before liquidation
    const liquidatorBalanceAfterLiquidation = exchangeTo === "0x0000000000000000000000000000000000000000" ? Fuse.Web3.utils.toBN(await fuse.web3.eth.getBalance(accounts[0])) : Fuse.Web3.utils.toBN(await (new fuse.web3.eth.Contract(erc20Abi, exchangeTo)).methods.balanceOf(accounts[0]).call());
    assert(liquidatorBalanceAfterLiquidation.gt(liquidatorBalanceBeforeLiquidation));
  }

  describe('#safeLiquidateToEthWithFlashLoan()', function() {
    // Safe liquidate ETH borrow with flashloan using Synthetix sEUR collateral + exchange seized collateral
    it('should liquidate an ETH borrow (using a flash swap) for Synthetix sEUR collateral and exchange to ETH', dryRun(async () => { await setupAndLiquidateUnhealthyEthBorrowWithTokenCollateral("0x0000000000000000000000000000000000000000", true, "0xd71ecff9342a5ced620049e616c5035f1db98620", "SynthetixSynth", fuse.web3.eth.abi.encodeParameters(["address"], ["0x5e74c9036fb86bd7ecdcb084a0673efc32ea31cb"]), UNISWAP_V2_PROTOCOLS.Uniswap.router) }));
    it('should liquidate an ETH borrow (using a flash swap) for Synthetix sEUR collateral and exchange to another token', dryRun(async () => { await setupAndLiquidateUnhealthyEthBorrowWithTokenCollateral("0xD291E7a03283640FDc51b121aC401383A46cC623", true, "0xd71ecff9342a5ced620049e616c5035f1db98620", "SynthetixSynth", fuse.web3.eth.abi.encodeParameters(["address"], ["0x5e74c9036fb86bd7ecdcb084a0673efc32ea31cb"]), UNISWAP_V2_PROTOCOLS.Uniswap.router) }));

    // Safe liquidate ETH borrow with flashloan using PoolTogether PcUSDC collateral + exchange seized collateral
    it('should liquidate an ETH borrow (using a flash swap) for PoolTogether PcUSDC collateral and exchange to ETH', dryRun(async () => { await setupAndLiquidateUnhealthyEthBorrowWithTokenCollateral("0x0000000000000000000000000000000000000000", true, "0xd81b1a8b1ad00baa2d6609e0bae28a38713872f7", "PoolTogether", undefined, UNISWAP_V2_PROTOCOLS.Uniswap.router) }));
    it('should liquidate an ETH borrow (using a flash swap) for PoolTogether PcUSDC collateral and exchange to another token', dryRun(async () => { await setupAndLiquidateUnhealthyEthBorrowWithTokenCollateral("0xD291E7a03283640FDc51b121aC401383A46cC623", true, "0xd81b1a8b1ad00baa2d6609e0bae28a38713872f7", "PoolTogether", undefined, UNISWAP_V2_PROTOCOLS.Uniswap.router) }));

    // Safe liquidate ETH borrow with flashloan using token collateral (via 0x) + exchange seized collateral
    /* function get0xQuote(sellToken) {
      var decoded = (await axios.get('https://api.0x.org/swap/v1/quote?sellToken=' + sellToken + '&buyToken=WETH&sellAmount=1000000000000000000', {
        params: {
          vs_currencies: "eth",
          sellAmount: tokenAddress
        }
      })).data;
      if (!decoded || !decoded[tokenAddress]) throw "Failed to decode price of " + tokenAddress + " from CoinGecko";
      return [res.to, res.data];
    }
    it('should liquidate an ETH borrow (using a flash swap) for token collateral (via 0x) and exchange to ETH', dryRun(async () => { await setupAndLiquidateUnhealthyEthBorrowWithTokenCollateral("0x0000000000000000000000000000000000000000", true, "0xae7ab96520de3a18e5e111b5eaab095312d7fe84", "ZeroEx", fuse.web3.eth.abi.encodeParameters(["address"], [Fuse.WETH_ADDRESS]), UNISWAP_V2_PROTOCOLS.Uniswap.router) }));
    it('should liquidate an ETH borrow (using a flash swap) for token collateral (via 0x) and exchange to another token', dryRun(async () => { await setupAndLiquidateUnhealthyEthBorrowWithTokenCollateral("0xD291E7a03283640FDc51b121aC401383A46cC623", true, "0xae7ab96520de3a18e5e111b5eaab095312d7fe84", "ZeroEx", fuse.web3.eth.abi.encodeParameters(["address"], [Fuse.WETH_ADDRESS]), UNISWAP_V2_PROTOCOLS.Uniswap.router) })); */

    // Safe liquidate ETH borrow with flashloan using token collateral (via Curve) + exchange seized collateral
    it('should liquidate an ETH borrow (using a flash swap) for token collateral (via Curve) and exchange to ETH', dryRun(async () => { await setupAndLiquidateUnhealthyEthBorrowWithTokenCollateral("0x0000000000000000000000000000000000000000", true, "0xae7ab96520de3a18e5e111b5eaab095312d7fe84", "CurveSwap", ...await getLiquidationStrategyData("0xae7ab96520de3a18e5e111b5eaab095312d7fe84", "CurveSwap")) }));
    it('should liquidate an ETH borrow (using a flash swap) for token collateral (via Curve) and exchange to another token', dryRun(async () => { await setupAndLiquidateUnhealthyEthBorrowWithTokenCollateral("0xD291E7a03283640FDc51b121aC401383A46cC623", true, "0xae7ab96520de3a18e5e111b5eaab095312d7fe84", "CurveSwap", ...await getLiquidationStrategyData("0xae7ab96520de3a18e5e111b5eaab095312d7fe84", "CurveSwap")) }));
  });

  describe('#safeLiquidateToTokensWithFlashLoan()', function() {
    // Safe liquidate token borrow with flashloan using Synthetix sEUR collateral + exchange seized collateral
    it('should liquidate a token borrow (using a flash swap) for Synthetix sEUR collateral and exchange to ETH', dryRun(async () => { await setupAndLiquidateUnhealthyTokenBorrowWithTokenCollateral("0x0000000000000000000000000000000000000000", true, "0xd71ecff9342a5ced620049e616c5035f1db98620", "SynthetixSynth", fuse.web3.eth.abi.encodeParameters(["address"], ["0x5e74c9036fb86bd7ecdcb084a0673efc32ea31cb"]), UNISWAP_V2_PROTOCOLS.Uniswap.router) }));
    it('should liquidate a token borrow (using a flash swap) for Synthetix sEUR collateral and exchange to another token', dryRun(async () => { await setupAndLiquidateUnhealthyTokenBorrowWithTokenCollateral("0xD291E7a03283640FDc51b121aC401383A46cC623", true, "0xd71ecff9342a5ced620049e616c5035f1db98620", "SynthetixSynth", fuse.web3.eth.abi.encodeParameters(["address"], ["0x5e74c9036fb86bd7ecdcb084a0673efc32ea31cb"]), UNISWAP_V2_PROTOCOLS.Uniswap.router) }));

    // Safe liquidate token borrow with flashloan using PoolTogether PcUSDC collateral + exchange seized collateral
    it('should liquidate a token borrow (using a flash swap) for PoolTogether PcUSDC collateral and exchange to ETH', dryRun(async () => { await setupAndLiquidateUnhealthyTokenBorrowWithTokenCollateral("0x0000000000000000000000000000000000000000", true, "0xd81b1a8b1ad00baa2d6609e0bae28a38713872f7", "PoolTogether", undefined, UNISWAP_V2_PROTOCOLS.Uniswap.router) }));
    it('should liquidate a token borrow (using a flash swap) for PoolTogether PcUSDC collateral and exchange to another token', dryRun(async () => { await setupAndLiquidateUnhealthyTokenBorrowWithTokenCollateral("0xD291E7a03283640FDc51b121aC401383A46cC623", true, "0xd81b1a8b1ad00baa2d6609e0bae28a38713872f7", "PoolTogether", undefined, UNISWAP_V2_PROTOCOLS.Uniswap.router) }));

    // Safe liquidate token borrow with flashloan using token collateral (via Curve) + exchange seized collateral
    it('should liquidate a token borrow (using a flash swap) for token collateral (via Curve) and exchange to ETH', dryRun(async () => { await setupAndLiquidateUnhealthyTokenBorrowWithTokenCollateral("0x0000000000000000000000000000000000000000", true, "0xae7ab96520de3a18e5e111b5eaab095312d7fe84", "CurveSwap", ...await getLiquidationStrategyData("0xae7ab96520de3a18e5e111b5eaab095312d7fe84", "CurveSwap")) }));
    it('should liquidate a token borrow (using a flash swap) for token collateral (via Curve) and exchange to another token', dryRun(async () => { await setupAndLiquidateUnhealthyTokenBorrowWithTokenCollateral("0xD291E7a03283640FDc51b121aC401383A46cC623", true, "0xae7ab96520de3a18e5e111b5eaab095312d7fe84", "CurveSwap", ...await getLiquidationStrategyData("0xae7ab96520de3a18e5e111b5eaab095312d7fe84", "CurveSwap")) }));
  });
});
